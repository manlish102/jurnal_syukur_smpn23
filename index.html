<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Syukur - SMP Negeri 23 Balikpapan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .tagline-text { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <!-- Main Title -->
        <div class="absolute top-8 left-0 right-0 text-center">
            <h1 class="text-4xl font-bold text-white mb-2 tagline-text">
                üìù JURNAL SYUKUR
            </h1>
            <h2 class="text-2xl font-semibold text-white tagline-text">
                SMP NEGERI 23 BALIKPAPAN
            </h2>
        </div>
        
        <div class="bg-white rounded-3xl card-shadow p-8 w-full max-w-md animate-fade-in mt-32">
            <!-- School Logo -->
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden border-4 border-blue-200 bg-blue-50 flex items-center justify-center">
                    <img src="https://lh3.googleusercontent.com/d/1jFcJifxi49yXv6_wz5bnuT6oRFVbzD_E" alt="Logo SMP Negeri 23 Balikpapan" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display:none;" class="text-blue-600 text-2xl font-bold">23</div>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">SMP NEGERI 23</h1>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">BALIKPAPAN</h2>
                
                <!-- Tagline with different colors -->
                <div class="tagline-text text-lg font-semibold mb-6">
                    <span class="text-red-600">S</span><span class="text-orange-500">P</span><span class="text-yellow-500">E</span><span class="text-green-500">N</span><span class="text-blue-500">D</span><span class="text-indigo-500">U</span><span class="text-purple-500">G</span><span class="text-pink-500">A</span>
                    <span class="text-gray-700"> HEBAT</span>
                </div>
                <div class="text-sm text-gray-600 mb-4 text-center">
                    <span class="text-red-600 font-semibold">H</span>ONEST ‚Ä¢ 
                    <span class="text-orange-500 font-semibold">E</span>XCELLENT ‚Ä¢ 
                    <span class="text-yellow-500 font-semibold">B</span>ETTER ‚Ä¢ 
                    <span class="text-green-500 font-semibold">A</span>TTENTIVE ‚Ä¢ 
                    <span class="text-blue-500 font-semibold">T</span>HANKFUL
                </div>
            </div>

            <!-- Motivational Quote -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-6">
                <p id="motivationalQuote" class="text-sm text-gray-700 italic text-center"></p>
            </div>

            <!-- Role Selection -->
            <div class="space-y-3">
                <button type="button" onclick="showLoginForm('kepala')" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-300 transform hover:scale-105">
                    üë®‚Äçüíº Kepala Sekolah
                </button>
                <button type="button" onclick="showLoginForm('wali')" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-105">
                    üë©‚Äçüè´ Wali Kelas
                </button>
                <button type="button" onclick="showLoginForm('siswa')" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-purple-700 hover:to-purple-800 transition-all duration-300 transform hover:scale-105">
                    üë®‚Äçüéì Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Login Form Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 id="loginTitle" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="closeLoginModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label id="usernameLabel" class="block text-sm font-medium text-gray-700 mb-2"></label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Kepala Sekolah Dashboard -->
    <div id="kepalaDashboard" class="hidden min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-bold text-gray-800">Dashboard Kepala Sekolah</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="kepalaName" class="text-gray-700 font-medium">Kepala Sekolah</span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <!-- Menu Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('profileSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Profil</h3>
                            <p class="text-sm text-gray-600">Update profil Anda</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('waliKelasSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Kelola Wali Kelas</h3>
                            <p class="text-sm text-gray-600">Tambah, edit, hapus wali kelas</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('monitoringSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Monitoring Kelas</h3>
                            <p class="text-sm text-gray-600">Pantau aktivitas jurnal syukur</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('laporanSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Laporan</h3>
                            <p class="text-sm text-gray-600">Buat laporan harian, mingguan, bulanan</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('siswaAktifSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Siswa Teraktif</h3>
                            <p class="text-sm text-gray-600">Lihat dan beri penghargaan</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('kelasSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-orange-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Kelola Kelas</h3>
                            <p class="text-sm text-gray-600">Tambah, edit, hapus kelas</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSection('backupSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Backup Data</h3>
                            <p class="text-sm text-gray-600">Kelola dan backup data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Sections -->
            <div id="contentArea" class="bg-white rounded-xl card-shadow p-6">
                <div id="welcomeSection">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Selamat Datang, Kepala Sekolah!</h2>
                    <p class="text-gray-600 mb-6">Pilih menu di atas untuk mengelola sistem Jurnal Syukur SMP Negeri 23 Balikpapan.</p>
                    
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Kelas</h3>
                            <p class="text-2xl font-bold" id="totalKelas">18</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Wali Kelas</h3>
                            <p class="text-2xl font-bold" id="totalWaliKelas">18</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Siswa Aktif Hari Ini</h3>
                            <p class="text-2xl font-bold" id="siswaAktifHariIni">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Jurnal Hari Ini</h3>
                            <p class="text-2xl font-bold" id="jurnalHariIni">0</p>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profil Kepala Sekolah</h2>
                    <form id="kepalaProfileForm" onsubmit="updateKepalaProfile(event)" class="max-w-md">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                            <input type="text" id="kepalaNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="kepalaNamaLengkap" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                            <input type="password" id="kepalaPasswordBaru" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Update Profil
                        </button>
                    </form>
                </div>

                <!-- Wali Kelas Management Section -->
                <div id="waliKelasSection" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Kelola Wali Kelas</h2>
                        <div class="space-x-2">
                            <button onclick="showAddWaliForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                + Tambah Manual
                            </button>
                            <button onclick="document.getElementById('excelWaliInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üìÅ Import Excel
                            </button>
                            <input type="file" id="excelWaliInput" accept=".xlsx,.xls" style="display: none;" onchange="importWaliFromExcel(event)">
                            <button onclick="downloadWaliTemplate()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üì• Download Template
                            </button>
                        </div>
                    </div>

                    <!-- Action Controls -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Wali Kelas</label>
                                <select id="selectWaliKelas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">-- Pilih Wali Kelas --</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="editSelectedWali()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    ‚úèÔ∏è Edit
                                </button>
                            </div>
                            <div>
                                <button onclick="resetSelectedWaliPassword()" class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                    üîë Reset Password
                                </button>
                            </div>
                            <div>
                                <button onclick="deleteSelectedWali()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    üóëÔ∏è Hapus
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Wali Kelas Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">NIP</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. WA</th>
                                </tr>
                            </thead>
                            <tbody id="waliKelasTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Wali Form (Hidden by default) -->
                    <div id="addWaliForm" class="hidden mt-6 bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Tambah Wali Kelas Baru</h3>
                        <form onsubmit="addWaliKelas(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                                <input type="text" id="newWaliNIP" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newWaliNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="newWaliKelas" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Pilih Kelas</option>
                                    <option value="7A">7A</option>
                                    <option value="7B">7B</option>
                                    <option value="7C">7C</option>
                                    <option value="7D">7D</option>
                                    <option value="7E">7E</option>
                                    <option value="7F">7F</option>
                                    <option value="8A">8A</option>
                                    <option value="8B">8B</option>
                                    <option value="8C">8C</option>
                                    <option value="8D">8D</option>
                                    <option value="8E">8E</option>
                                    <option value="8F">8F</option>
                                    <option value="9A">9A</option>
                                    <option value="9B">9B</option>
                                    <option value="9C">9C</option>
                                    <option value="9D">9D</option>
                                    <option value="9E">9E</option>
                                    <option value="9F">9F</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                                <input type="text" id="newWaliWA" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="08xxxxxxxxxx">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors mr-2">
                                    Simpan
                                </button>
                                <button type="button" onclick="hideAddWaliForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Monitoring Section -->
                <div id="monitoringSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitoring Kelas Teraktif</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="kelasMonitoringGrid">
                        <!-- Monitoring cards will be populated here -->
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-4">Kirim Laporan Massal</h3>
                        <div class="flex space-x-4">
                            <button onclick="kirimLaporanKeSemuaWali()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span>üì± Kirim ke Semua Wali Kelas</span>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">üí° Atau gunakan tombol "Kirim ke Wali Kelas" di setiap kartu kelas untuk mengirim laporan individual.</p>
                    </div>
                </div>

                <!-- Laporan Section -->
                <div id="laporanSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Laporan Jurnal Syukur</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button onclick="buatLaporan('harian')" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <h3 class="font-semibold">Laporan Harian</h3>
                            <p class="text-sm opacity-90">Laporan aktivitas hari ini</p>
                        </button>
                        <button onclick="buatLaporan('mingguan')" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors">
                            <h3 class="font-semibold">Laporan Mingguan</h3>
                            <p class="text-sm opacity-90">Laporan aktivitas minggu ini</p>
                        </button>
                        <button onclick="buatLaporan('bulanan')" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors">
                            <h3 class="font-semibold">Laporan Bulanan</h3>
                            <p class="text-sm opacity-90">Laporan aktivitas bulan ini</p>
                        </button>
                    </div>

                    <div id="laporanResult" class="bg-gray-50 p-6 rounded-lg hidden">
                        <h3 class="text-lg font-semibold mb-4">Hasil Laporan</h3>
                        <div id="laporanContent"></div>
                        <button onclick="downloadLaporan()" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            üì• Download PDF
                        </button>
                    </div>
                </div>

                <!-- Siswa Teraktif Section -->
                <div id="siswaAktifSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Siswa Teraktif</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button onclick="lihatSiswaAktif('mingguan')" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <h3 class="font-semibold">Top 10 Mingguan</h3>
                            <p class="text-sm opacity-90">Siswa teraktif minggu ini</p>
                        </button>
                        <button onclick="lihatSiswaAktif('bulanan')" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors">
                            <h3 class="font-semibold">Top 10 Bulanan</h3>
                            <p class="text-sm opacity-90">Siswa teraktif bulan ini</p>
                        </button>
                        <button onclick="lihatSiswaAktif('trimester')" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors">
                            <h3 class="font-semibold">Top 10 Trimester</h3>
                            <p class="text-sm opacity-90">Siswa teraktif 3 bulan</p>
                        </button>
                    </div>

                    <div id="siswaAktifResult" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Daftar Siswa Teraktif</h3>
                            <button onclick="kirimPiagam()" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                üèÜ Kirim Piagam
                            </button>
                        </div>
                        <div id="siswaAktifList" class="space-y-4">
                            <!-- List will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Kelas Management Section -->
                <div id="kelasSection" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Kelola Kelas</h2>
                        <div class="space-x-2">
                            <button onclick="showAddKelasForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                + Tambah Manual
                            </button>
                            <button onclick="document.getElementById('excelKelasInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üìÅ Import Excel
                            </button>
                            <input type="file" id="excelKelasInput" accept=".xlsx,.xls" style="display: none;" onchange="importKelasFromExcel(event)">
                            <button onclick="downloadKelasTemplate()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üì• Download Template
                            </button>
                            <button onclick="confirmDeleteAllSiswa()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                üóëÔ∏è Hapus Semua Siswa
                            </button>
                        </div>
                    </div>

                    <!-- Kelas Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Wali Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Jumlah Siswa</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kelasTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Kelas Form (Hidden by default) -->
                    <div id="addKelasForm" class="hidden mt-6 bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Tambah Kelas Baru</h3>
                        <form onsubmit="addKelas(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                                <input type="text" id="newKelasNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: 7G" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tingkat</label>
                                <select id="newKelasTingkat" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Pilih Tingkat</option>
                                    <option value="7">Kelas 7</option>
                                    <option value="8">Kelas 8</option>
                                    <option value="9">Kelas 9</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors mr-2">
                                    Simpan
                                </button>
                                <button type="button" onclick="hideAddKelasForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Backup Section -->
                <div id="backupSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Kelola Data</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-red-50 border border-red-200 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-red-800 mb-4">‚ö†Ô∏è Hapus Data Jurnal</h3>
                            <p class="text-red-700 mb-4">Hati-hati! Tindakan ini akan menghapus semua data jurnal syukur.</p>
                            <button onclick="confirmDeleteData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                üóëÔ∏è Hapus Semua Data
                            </button>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">üíæ Backup Data</h3>
                            <p class="text-green-700 mb-4">Buat backup data jurnal syukur untuk keamanan.</p>
                            <button onclick="createBackup()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üì¶ Buat Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wali Kelas Dashboard -->
    <div id="waliDashboard" class="hidden min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-bold text-gray-800">Dashboard Wali Kelas</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="waliName" class="text-gray-700 font-medium">Wali Kelas</span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <!-- Wali Kelas Menu Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showWaliSection('waliProfileSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Profil</h3>
                            <p class="text-sm text-gray-600">Update profil Anda</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showWaliSection('siswaSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Kelola Siswa</h3>
                            <p class="text-sm text-gray-600">Tambah, edit, hapus siswa</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showWaliSection('monitoringSiswaSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Monitor Siswa</h3>
                            <p class="text-sm text-gray-600">Pantau aktivitas siswa</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showWaliSection('backupSiswaSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Backup Data</h3>
                            <p class="text-sm text-gray-600">Kelola data siswa</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wali Content Area -->
            <div id="waliContentArea" class="bg-white rounded-xl card-shadow p-6">
                <div id="waliWelcomeSection">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Selamat Datang, Wali Kelas!</h2>
                    <p class="text-gray-600 mb-6">Kelola siswa dan pantau aktivitas jurnal syukur kelas Anda.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Kelas Anda</h3>
                            <p class="text-2xl font-bold" id="waliKelasInfo">-</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Siswa</h3>
                            <p class="text-2xl font-bold" id="totalSiswaKelas">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Aktif Hari Ini</h3>
                            <p class="text-2xl font-bold" id="siswaAktifHariIniKelas">0</p>
                        </div>
                    </div>
                </div>

                <!-- Wali Profile Section -->
                <div id="waliProfileSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profil Wali Kelas</h2>
                    <form id="waliProfileForm" onsubmit="updateWaliProfile(event)" class="max-w-md">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                            <input type="text" id="waliNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="waliNamaLengkap" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                            <input type="text" id="waliNoWA" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                            <input type="password" id="waliPasswordBaru" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Update Profil
                        </button>
                    </form>
                </div>

                <!-- Siswa Management Section -->
                <div id="siswaSection" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Kelola Siswa</h2>
                        <div class="space-x-2">
                            <button onclick="showAddSiswaForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                + Tambah Manual
                            </button>
                            <button onclick="document.getElementById('excelSiswaInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üìÅ Import Excel
                            </button>
                            <input type="file" id="excelSiswaInput" accept=".xlsx,.xls" style="display: none;" onchange="importSiswaFromExcel(event)">
                            <button onclick="downloadSiswaTemplate()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üì• Download Template
                            </button>
                        </div>
                    </div>

                    <!-- Siswa Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">NISN</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">No. WA</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Siswa Form -->
                    <div id="addSiswaForm" class="hidden mt-6 bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Tambah Siswa Baru</h3>
                        <form onsubmit="addSiswa(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                                <input type="text" id="newSiswaNISN" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newSiswaNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                                <input type="text" id="newSiswaWA" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="08xxxxxxxxxx">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors mr-2">
                                    Simpan
                                </button>
                                <button type="button" onclick="hideAddSiswaForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Monitoring Siswa Section -->
                <div id="monitoringSiswaSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitor Siswa Teraktif</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="siswaMonitoringGrid">
                        <!-- Monitoring cards will be populated here -->
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-4">Kirim Pengingat ke WhatsApp Siswa</h3>
                        <div class="flex space-x-4">
                            <select id="pilihSiswaWA" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Pilih Siswa</option>
                                <option value="all">Semua Siswa</option>
                            </select>
                            <button onclick="kirimPesanSiswaWA()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üì± Kirim ke WA Siswa
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup Siswa Section -->
                <div id="backupSiswaSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Kelola Data Siswa</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-red-50 border border-red-200 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-red-800 mb-4">‚ö†Ô∏è Hapus Data Jurnal Siswa</h3>
                            <p class="text-red-700 mb-4">Hapus data jurnal syukur siswa setiap bulan.</p>
                            <button onclick="confirmDeleteSiswaData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                üóëÔ∏è Hapus Data Bulan Ini
                            </button>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">üíæ Backup Data Siswa</h3>
                            <p class="text-green-700 mb-4">Buat backup data jurnal siswa kelas Anda.</p>
                            <button onclick="createSiswaBackup()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                üì¶ Buat Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Siswa Dashboard -->
    <div id="siswaDashboard" class="hidden min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-bold text-gray-800">Jurnal Syukur</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="siswaName" class="text-gray-700 font-medium">Siswa</span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-6">
            <!-- Siswa Menu Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSiswaSection('siswaProfileSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Profil</h3>
                            <p class="text-sm text-gray-600">Update profil Anda</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 hover:transform hover:scale-105 transition-all duration-300 cursor-pointer" onclick="showSiswaSection('jurnalSection')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1  0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Tulis Jurnal Syukur</h3>
                            <p class="text-sm text-gray-600">Tuliskan hal-hal yang disyukuri</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Siswa Content Area -->
            <div id="siswaContentArea" class="bg-white rounded-xl card-shadow p-6">
                <div id="siswaWelcomeSection">
                    <!-- Daily Motivation -->
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-xl mb-6">
                        <h2 class="text-xl font-bold mb-2">üí´ Motivasi Hari Ini</h2>
                        <p id="dailyMotivation" class="text-lg"></p>
                    </div>

                    <!-- Achievement Notifications -->
                    <div id="achievementNotification" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-xl mb-6">
                        <h2 class="text-xl font-bold mb-2">üéâ Selamat!</h2>
                        <p id="achievementText"></p>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Streak Hari Ini</h3>
                            <p class="text-2xl font-bold" id="siswaStreak">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Jurnal</h3>
                            <p class="text-2xl font-bold" id="totalJurnalSiswa">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Bulan Ini</h3>
                            <p class="text-2xl font-bold" id="jurnalBulanIni">0</p>
                        </div>
                    </div>

                    <!-- Quick Journal Entry -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ú® Tulis Jurnal Syukur Hari Ini</h3>
                        <p class="text-gray-600 mb-4">Tuliskan 3 hal baik yang Anda syukuri hari ini</p>
                        <button onclick="showSiswaSection('jurnalSection')" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-300">
                            üìù Mulai Menulis
                        </button>
                    </div>
                </div>

                <!-- Siswa Profile Section -->
                <div id="siswaProfileSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profil Siswa</h2>
                    <form id="siswaProfileForm" onsubmit="updateSiswaProfile(event)" class="max-w-md">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                            <input type="text" id="siswaNISN" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="siswaNamaLengkap" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                            <input type="text" id="siswaNoWA" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                            <input type="password" id="siswaPasswordBaru" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Update Profil
                        </button>
                    </form>
                </div>

                <!-- Journal Section -->
                <div id="jurnalSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Jurnal Syukur Hari Ini</h2>
                    
                    <!-- Daily Motivation in Journal -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl mb-6">
                        <h3 class="text-lg font-bold mb-2">üí° Motivasi Hari Ini</h3>
                        <p id="jurnalMotivation"></p>
                    </div>

                    <!-- Already Submitted Today Notice -->
                    <div id="alreadySubmittedNotice" class="hidden bg-blue-50 border border-blue-200 p-6 rounded-xl mb-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-blue-800">‚úÖ Jurnal Hari Ini Sudah Terisi!</h3>
                                <p class="text-blue-700">Anda sudah mengisi jurnal syukur hari ini</p>
                            </div>
                        </div>
                        <div id="todayJurnalPreview" class="bg-white p-4 rounded-lg border border-blue-200">
                            <!-- Today's journal will be displayed here -->
                        </div>
                        <p class="text-sm text-blue-600 mt-4">üí° Kembali besok untuk menulis jurnal syukur yang baru!</p>
                    </div>

                    <!-- Journal Form -->
                    <form id="jurnalForm" onsubmit="submitJurnal(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                1. Hal pertama yang saya syukuri hari ini:
                            </label>
                            <textarea id="syukur1" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Alhamdulillah hari ini saya mendapat hadiah dari om" required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                2. Hal kedua yang saya syukuri hari ini:
                            </label>
                            <textarea id="syukur2" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Alhamdulillah hari ini saya bisa membantu teman" required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                3. Hal ketiga yang saya syukuri hari ini:
                            </label>
                            <textarea id="syukur3" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Alhamdulillah hari ini cuaca cerah dan indah" required></textarea>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 px-6 rounded-lg font-semibold hover:from-green-600 hover:to-blue-600 transition-all duration-300 transform hover:scale-105">
                            üíæ Simpan Jurnal Syukur
                        </button>
                    </form>

                    <!-- Testimony Section (for 3-month active students) -->
                    <div id="testimonySection" class="hidden mt-8 bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
                        <h3 class="text-lg font-bold text-orange-800 mb-4">üåü Bagikan Pengalaman Anda!</h3>
                        <p class="text-orange-700 mb-4">Silahkan bagikan pengalamanmu setelah menulis Jurnal syukur selama 3 bulan berturut-turut agar bisa dijadikan contoh bagi teman yang lain</p>
                        <textarea id="testimonyText" rows="4" class="w-full px-4 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Bagikan pengalaman positif Anda..."></textarea>
                        <button onclick="submitTestimony()" class="mt-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-3 rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all duration-300">
                            üì§ Kirim Testimoni
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let waliKelasData = [
            {nip: '07', nama: 'Rahmah Saniah, S.Pd', kelas: '7A', wa: '', password: 'guru123'}
        ];

        let siswaData = {};
        let jurnalData = {};
        let kelasData = [
            {nama: '7A', tingkat: '7', status: 'Aktif'},
            {nama: '7B', tingkat: '7', status: 'Aktif'},
            {nama: '7C', tingkat: '7', status: 'Aktif'},
            {nama: '7D', tingkat: '7', status: 'Aktif'},
            {nama: '7E', tingkat: '7', status: 'Aktif'},
            {nama: '7F', tingkat: '7', status: 'Aktif'},
            {nama: '8A', tingkat: '8', status: 'Aktif'},
            {nama: '8B', tingkat: '8', status: 'Aktif'},
            {nama: '8C', tingkat: '8', status: 'Aktif'},
            {nama: '8D', tingkat: '8', status: 'Aktif'},
            {nama: '8E', tingkat: '8', status: 'Aktif'},
            {nama: '8F', tingkat: '8', status: 'Aktif'},
            {nama: '9A', tingkat: '9', status: 'Aktif'},
            {nama: '9B', tingkat: '9', status: 'Aktif'},
            {nama: '9C', tingkat: '9', status: 'Aktif'},
            {nama: '9D', tingkat: '9', status: 'Aktif'},
            {nama: '9E', tingkat: '9', status: 'Aktif'},
            {nama: '9F', tingkat: '9', status: 'Aktif'}
        ];
        let kepalaSekolahData = {
            nip: '',
            nama: 'Kepala Sekolah',
            password: 'kepala123'
        };

        // Motivational quotes
        const motivationalQuotes = [
            "Bersyukur adalah kunci kebahagiaan sejati. Mulailah hari ini dengan hati yang penuh syukur!",
            "Setiap hari adalah anugerah baru. Temukan hal-hal kecil yang bisa disyukuri hari ini.",
            "Syukur mengubah apa yang kita miliki menjadi cukup, dan lebih dari cukup.",
            "Ketika kita bersyukur, kita membuka pintu untuk lebih banyak berkah dalam hidup.",
            "Bersyukur bukan hanya tentang hal-hal besar, tapi juga tentang keajaiban kecil sehari-hari.",
            "Hati yang bersyukur adalah magnet untuk keajaiban hidup.",
            "Syukur adalah cara terbaik untuk mengubah perspektif dan menemukan kebahagiaan.",
            "Setiap napas adalah alasan untuk bersyukur. Hargai setiap momen yang diberikan.",
            "Bersyukur membuat kita kaya, meskipun kita memiliki sedikit.",
            "Mulai hari dengan syukur, akhiri hari dengan syukur. Itulah resep kebahagiaan."
        ];

        const dailyMotivations = [
            "Hari ini adalah kesempatan baru untuk berbuat kebaik. Manfaatkan dengan sebaik-baiknya!",
            "Setiap langkah kecil menuju kebaikan adalah pencapaian yang luar biasa.",
            "Kamu memiliki kekuatan untuk membuat hari ini menjadi hari yang bermakna.",
            "Bersyukur hari ini akan membuka jalan untuk kebahagiaan esok hari.",
            "Jadilah alasan seseorang tersenyum hari ini. Kebaikanmu sangat berarti.",
            "Hari ini penuh dengan kemungkinan indah. Buka mata dan hatimu untuk melihatnya.",
            "Setiap tantangan hari ini adalah kesempatan untuk tumbuh menjadi lebih kuat.",
            "Kamu lebih kuat dari yang kamu kira. Percayalah pada kemampuanmu!",
            "Hari ini adalah kanvas kosong. Lukislah dengan warna-warna kebaikan dan syukur.",
            "Senyummu hari ini bisa menjadi sinar terang bagi orang lain."
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showRandomMotivationalQuote();
            loadDataFromStorage();
        });

        // Data management functions
        function loadDataFromStorage() {
            const savedWaliData = localStorage.getItem('waliKelasData');
            if (savedWaliData) {
                waliKelasData = JSON.parse(savedWaliData);
            }
            
            const savedSiswaData = localStorage.getItem('siswaData');
            if (savedSiswaData) {
                siswaData = JSON.parse(savedSiswaData);
            }
            
            const savedJurnalData = localStorage.getItem('jurnalData');
            if (savedJurnalData) {
                jurnalData = JSON.parse(savedJurnalData);
            }
            
            const savedKelasData = localStorage.getItem('kelasData');
            if (savedKelasData) {
                kelasData = JSON.parse(savedKelasData);
            }
            
            const savedKepalaData = localStorage.getItem('kepalaSekolahData');
            if (savedKepalaData) {
                kepalaSekolahData = JSON.parse(savedKepalaData);
            }
        }

        function saveDataToStorage() {
            localStorage.setItem('waliKelasData', JSON.stringify(waliKelasData));
            localStorage.setItem('siswaData', JSON.stringify(siswaData));
            localStorage.setItem('jurnalData', JSON.stringify(jurnalData));
            localStorage.setItem('kelasData', JSON.stringify(kelasData));
            localStorage.setItem('kepalaSekolahData', JSON.stringify(kepalaSekolahData));
        }

        function loadKepalaData() {
            // Update dashboard stats
            document.getElementById('totalKelas').textContent = kelasData.length;
            document.getElementById('totalWaliKelas').textContent = waliKelasData.length;
            
            const today = new Date().toISOString().split('T')[0];
            let siswaAktifHariIni = 0;
            let jurnalHariIni = 0;
            
            Object.values(siswaData).forEach(siswa => {
                if (jurnalData[siswa.nisn] && jurnalData[siswa.nisn][today]) {
                    siswaAktifHariIni++;
                    jurnalHariIni++;
                }
            });
            
            document.getElementById('siswaAktifHariIni').textContent = siswaAktifHariIni;
            document.getElementById('jurnalHariIni').textContent = jurnalHariIni;
        }

        function loadWaliData() {
            const siswaKelas = Object.values(siswaData).filter(s => s.kelas === currentUser.kelas);
            document.getElementById('totalSiswaKelas').textContent = siswaKelas.length;
            
            const today = new Date().toISOString().split('T')[0];
            const siswaAktifHariIni = siswaKelas.filter(s => {
                return jurnalData[s.nisn] && jurnalData[s.nisn][today];
            }).length;
            
            document.getElementById('siswaAktifHariIniKelas').textContent = siswaAktifHariIni;
        }

        function loadSiswaData() {
            const userJurnals = jurnalData[currentUser.nisn] || {};
            const totalJurnal = Object.keys(userJurnals).length;
            
            document.getElementById('siswaStreak').textContent = currentUser.streak || 0;
            document.getElementById('totalJurnalSiswa').textContent = totalJurnal;
            
            // Calculate this month's journals
            const thisMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
            const jurnalBulanIni = Object.keys(userJurnals).filter(date => date.startsWith(thisMonth)).length;
            document.getElementById('jurnalBulanIni').textContent = jurnalBulanIni;
        }

        function showRandomMotivationalQuote() {
            // Use current date to ensure same quote for the whole day
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quoteIndex = dayOfYear % motivationalQuotes.length;
            const quote = motivationalQuotes[quoteIndex];
            document.getElementById('motivationalQuote').textContent = quote;
        }

        function showDailyMotivation() {
            // Use current date to ensure same motivation for the whole day
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const motivationIndex = dayOfYear % dailyMotivations.length;
            const motivation = dailyMotivations[motivationIndex];
            const elements = document.querySelectorAll('#dailyMotivation, #jurnalMotivation');
            elements.forEach(el => el.textContent = motivation);
        }

        function showLoginForm(role) {
            console.log('showLoginForm called with role:', role);
            
            const modal = document.getElementById('loginModal');
            const title = document.getElementById('loginTitle');
            const usernameLabel = document.getElementById('usernameLabel');
            
            if (!modal || !title || !usernameLabel) {
                console.error('Modal elements not found');
                return;
            }
            
            currentRole = role;
            
            switch(role) {
                case 'kepala':
                    title.textContent = 'Login Kepala Sekolah';
                    usernameLabel.textContent = 'NIP';
                    break;
                case 'wali':
                    title.textContent = 'Login Wali Kelas';
                    usernameLabel.textContent = 'NIP';
                    break;
                case 'siswa':
                    title.textContent = 'Login Siswa';
                    usernameLabel.textContent = 'NISN';
                    break;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.style.display = 'flex';
            
            console.log('Modal should be visible now');
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            const form = document.getElementById('loginForm');
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.style.display = 'none';
            
            if (form) {
                form.reset();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                alert('Silakan isi username dan password!');
                return;
            }
            
            let loginSuccess = false;
            let errorMessage = '';
            
            try {
                switch(currentRole) {
                    case 'kepala':
                        // For kepala sekolah, check password
                        if (password === kepalaSekolahData.password) {
                            loginSuccess = true;
                            if (username) kepalaSekolahData.nip = username;
                            currentUser = kepalaSekolahData;
                            closeLoginModal();
                            document.getElementById('loginPage').classList.add('hidden');
                            showKepalaDashboard();
                        } else {
                            errorMessage = 'Password salah! Password default Kepala Sekolah adalah "kepala123"';
                        }
                        break;
                        
                    case 'wali':
                        // Find wali by NIP and check password - ensure string comparison
                        const wali = waliKelasData.find(w => String(w.nip) === String(username));
                        if (!wali) {
                            errorMessage = `NIP "${username}" tidak ditemukan!\n\nNIP Wali Kelas yang tersedia:\n${waliKelasData.map(w => `- ${w.nip} (${w.nama} - ${w.kelas})`).join('\n')}`;
                        } else if (String(wali.password || 'guru123') !== String(password)) {
                            errorMessage = `Password salah untuk ${wali.nama}!\nPassword default Wali Kelas adalah "guru123"`;
                        } else {
                            loginSuccess = true;
                            currentUser = {...wali}; // Create a copy to avoid reference issues
                            // Ensure password is set if missing
                            if (!currentUser.password) {
                                currentUser.password = 'guru123';
                            }
                            closeLoginModal();
                            document.getElementById('loginPage').classList.add('hidden');
                            showWaliDashboard();
                        }
                        break;
                        
                    case 'siswa':
                        // Check if student exists - ensure string comparison
                        const siswa = siswaData[String(username)];
                        if (!siswa) {
                            errorMessage = `NISN "${username}" tidak ditemukan!\n\nSilakan hubungi wali kelas untuk mendaftarkan NISN Anda, atau gunakan NISN yang sudah terdaftar.`;
                        } else if (String(siswa.password || '123456') !== String(password)) {
                            errorMessage = `Password salah untuk ${siswa.nama}!\nPassword default Siswa adalah "123456"`;
                        } else {
                            loginSuccess = true;
                            currentUser = {...siswa}; // Create a copy to avoid reference issues
                            // Ensure password is set if missing
                            if (!currentUser.password) {
                                currentUser.password = '123456';
                            }
                            closeLoginModal();
                            document.getElementById('loginPage').classList.add('hidden');
                            showSiswaDashboard();
                        }
                        break;
                }
                
                if (!loginSuccess && errorMessage) {
                    alert(errorMessage);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Terjadi kesalahan saat login. Silakan coba lagi.');
            }
        }

        function showKepalaDashboard() {
            document.getElementById('kepalaDashboard').classList.remove('hidden');
            document.getElementById('kepalaName').textContent = kepalaSekolahData.nama;
            loadKepalaData();
            populateWaliKelasTable();
            updateMonitoringKelas();
        }

        function showWaliDashboard() {
            document.getElementById('waliDashboard').classList.remove('hidden');
            document.getElementById('waliName').textContent = currentUser.nama;
            document.getElementById('waliKelasInfo').textContent = currentUser.kelas;
            loadWaliData();
            populateSiswaTable();
            updateSiswaMonitoring();
        }

        function showSiswaDashboard() {
            document.getElementById('siswaDashboard').classList.remove('hidden');
            document.getElementById('siswaName').textContent = currentUser.nama;
            showDailyMotivation();
            loadSiswaData();
            checkAchievements();
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            
            // Hide all dashboards
            document.getElementById('kepalaDashboard').classList.add('hidden');
            document.getElementById('waliDashboard').classList.add('hidden');
            document.getElementById('siswaDashboard').classList.add('hidden');
            
            // Show login page
            document.getElementById('loginPage').classList.remove('hidden');
            
            // Reset forms
            document.querySelectorAll('form').forEach(form => form.reset());
            
            // Show welcome sections
            showSection('welcomeSection');
            showWaliSection('waliWelcomeSection');
            showSiswaSection('siswaWelcomeSection');
        }

        function showSection(sectionId) {
            // Hide all sections in kepala dashboard
            const sections = ['welcomeSection', 'profileSection', 'waliKelasSection', 'monitoringSection', 'laporanSection', 'siswaAktifSection', 'kelasSection', 'backupSection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Load section-specific data
            if (sectionId === 'profileSection') {
                loadKepalaProfileForm();
            } else if (sectionId === 'kelasSection') {
                populateKelasTable();
            }
        }

        function showWaliSection(sectionId) {
            // Hide all wali sections
            const sections = ['waliWelcomeSection', 'waliProfileSection', 'siswaSection', 'monitoringSiswaSection', 'backupSiswaSection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Load section-specific data
            if (sectionId === 'waliProfileSection') {
                loadWaliProfileForm();
            }
        }

        function showSiswaSection(sectionId) {
            // Hide all siswa sections
            const sections = ['siswaWelcomeSection', 'siswaProfileSection', 'jurnalSection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Load section-specific data
            if (sectionId === 'siswaProfileSection') {
                loadSiswaProfileForm();
            } else if (sectionId === 'jurnalSection') {
                showDailyMotivation();
                checkTestimonyEligibility();
                checkTodayJournalStatus();
            }
        }

        // Profile management functions
        function loadKepalaProfileForm() {
            document.getElementById('kepalaNIP').value = kepalaSekolahData.nip;
            document.getElementById('kepalaNamaLengkap').value = kepalaSekolahData.nama;
        }

        function updateKepalaProfile(event) {
            event.preventDefault();
            
            kepalaSekolahData.nip = document.getElementById('kepalaNIP').value;
            kepalaSekolahData.nama = document.getElementById('kepalaNamaLengkap').value;
            
            const newPassword = document.getElementById('kepalaPasswordBaru').value;
            if (newPassword) {
                kepalaSekolahData.password = newPassword;
            }
            
            document.getElementById('kepalaName').textContent = kepalaSekolahData.nama;
            saveDataToStorage();
            alert('Profil berhasil diupdate!');
        }

        function loadWaliProfileForm() {
            document.getElementById('waliNIP').value = currentUser.nip;
            document.getElementById('waliNamaLengkap').value = currentUser.nama;
            document.getElementById('waliNoWA').value = currentUser.wa || '';
        }

        function updateWaliProfile(event) {
            event.preventDefault();
            
            currentUser.nip = document.getElementById('waliNIP').value;
            currentUser.nama = document.getElementById('waliNamaLengkap').value;
            currentUser.wa = document.getElementById('waliNoWA').value;
            
            const newPassword = document.getElementById('waliPasswordBaru').value;
            if (newPassword) {
                currentUser.password = newPassword;
            }
            
            document.getElementById('waliName').textContent = currentUser.nama;
            saveDataToStorage();
            alert('Profil berhasil diupdate!');
        }

        function loadSiswaProfileForm() {
            document.getElementById('siswaNISN').value = currentUser.nisn;
            document.getElementById('siswaNamaLengkap').value = currentUser.nama;
            document.getElementById('siswaNoWA').value = currentUser.wa || '';
        }

        function updateSiswaProfile(event) {
            event.preventDefault();
            
            const oldNISN = currentUser.nisn;
            const newNISN = document.getElementById('siswaNISN').value;
            
            currentUser.nisn = newNISN;
            currentUser.nama = document.getElementById('siswaNamaLengkap').value;
            currentUser.wa = document.getElementById('siswaNoWA').value;
            
            const newPassword = document.getElementById('siswaPasswordBaru').value;
            if (newPassword) {
                currentUser.password = newPassword;
            }
            
            // Update siswaData key if NISN changed
            if (oldNISN !== newNISN) {
                siswaData[newNISN] = currentUser;
                delete siswaData[oldNISN];
            }
            
            document.getElementById('siswaName').textContent = currentUser.nama;
            saveDataToStorage();
            alert('Profil berhasil diupdate!');
        }

        // Wali Kelas Management
        function populateWaliKelasTable() {
            const tbody = document.getElementById('waliKelasTableBody');
            const selectWali = document.getElementById('selectWaliKelas');
            
            tbody.innerHTML = '';
            selectWali.innerHTML = '<option value="">-- Pilih Wali Kelas --</option>';
            
            waliKelasData.forEach((wali, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${wali.nip}</td>
                    <td class="border border-gray-300 px-4 py-2">${wali.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${wali.kelas}</td>
                    <td class="border border-gray-300 px-4 py-2">${wali.wa || '-'}</td>
                `;
                
                // Add to select dropdown
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${wali.nama} - ${wali.kelas}`;
                selectWali.appendChild(option);
            });
            
            // Update total wali kelas
            document.getElementById('totalWaliKelas').textContent = waliKelasData.length;
        }

        function showAddWaliForm() {
            document.getElementById('addWaliForm').classList.remove('hidden');
        }

        function hideAddWaliForm() {
            document.getElementById('addWaliForm').classList.add('hidden');
            document.getElementById('addWaliForm').querySelector('form').reset();
        }

        function addWaliKelas(event) {
            event.preventDefault();
            
            const newWali = {
                nip: document.getElementById('newWaliNIP').value,
                nama: document.getElementById('newWaliNama').value,
                kelas: document.getElementById('newWaliKelas').value,
                wa: document.getElementById('newWaliWA').value,
                password: 'guru123'
            };
            
            waliKelasData.push(newWali);
            populateWaliKelasTable();
            hideAddWaliForm();
            saveDataToStorage();
            alert('Wali kelas berhasil ditambahkan!');
        }

        function editSelectedWali() {
            const selectWali = document.getElementById('selectWaliKelas');
            const selectedIndex = selectWali.value;
            
            if (!selectedIndex || selectedIndex === '') {
                alert('Silakan pilih wali kelas terlebih dahulu!');
                return;
            }
            
            const index = parseInt(selectedIndex);
            const wali = waliKelasData[index];
            
            if (!wali) {
                alert('Data wali kelas tidak ditemukan!');
                return;
            }
            
            // Show edit form with current data
            showEditWaliModal(index, wali);
        }

        function showEditWaliModal(index, wali) {
            // Create modal for editing
            const modal = document.createElement('div');
            modal.id = 'editWaliModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Edit Wali Kelas</h3>
                        <button onclick="closeEditWaliModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="updateWaliData(event, ${index})">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                            <input type="text" id="editWaliNIP" value="${wali.nip}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="editWaliNama" value="${wali.nama}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="editWaliKelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                <option value="">Pilih Kelas</option>
                                <option value="7A" ${wali.kelas === '7A' ? 'selected' : ''}>7A</option>
                                <option value="7B" ${wali.kelas === '7B' ? 'selected' : ''}>7B</option>
                                <option value="7C" ${wali.kelas === '7C' ? 'selected' : ''}>7C</option>
                                <option value="7D" ${wali.kelas === '7D' ? 'selected' : ''}>7D</option>
                                <option value="7E" ${wali.kelas === '7E' ? 'selected' : ''}>7E</option>
                                <option value="7F" ${wali.kelas === '7F' ? 'selected' : ''}>7F</option>
                                <option value="8A" ${wali.kelas === '8A' ? 'selected' : ''}>8A</option>
                                <option value="8B" ${wali.kelas === '8B' ? 'selected' : ''}>8B</option>
                                <option value="8C" ${wali.kelas === '8C' ? 'selected' : ''}>8C</option>
                                <option value="8D" ${wali.kelas === '8D' ? 'selected' : ''}>8D</option>
                                <option value="8E" ${wali.kelas === '8E' ? 'selected' : ''}>8E</option>
                                <option value="8F" ${wali.kelas === '8F' ? 'selected' : ''}>8F</option>
                                <option value="9A" ${wali.kelas === '9A' ? 'selected' : ''}>9A</option>
                                <option value="9B" ${wali.kelas === '9B' ? 'selected' : ''}>9B</option>
                                <option value="9C" ${wali.kelas === '9C' ? 'selected' : ''}>9C</option>
                                <option value="9D" ${wali.kelas === '9D' ? 'selected' : ''}>9D</option>
                                <option value="9E" ${wali.kelas === '9E' ? 'selected' : ''}>9E</option>
                                <option value="9F" ${wali.kelas === '9F' ? 'selected' : ''}>9F</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                            <input type="text" id="editWaliWA" value="${wali.wa || ''}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="08xxxxxxxxxx">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                üíæ Update
                            </button>
                            <button type="button" onclick="closeEditWaliModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                                ‚ùå Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function updateWaliData(event, index) {
            event.preventDefault();
            
            const newNIP = document.getElementById('editWaliNIP').value.trim();
            const newNama = document.getElementById('editWaliNama').value.trim();
            const newKelas = document.getElementById('editWaliKelas').value.trim();
            const newWA = document.getElementById('editWaliWA').value.trim();
            
            if (!newNIP || !newNama || !newKelas) {
                alert('Harap isi semua field yang wajib!');
                return;
            }
            
            // Store old data for comparison
            const oldWali = {...waliKelasData[index]};
            
            // Update the wali object directly in the array
            waliKelasData[index] = {
                ...waliKelasData[index],
                nip: newNIP,
                nama: newNama,
                kelas: newKelas,
                wa: newWA
            };
            
            // Update current user if editing own data
            if (currentUser && currentRole === 'wali' && 
                currentUser.nip === oldWali.nip && 
                currentUser.kelas === oldWali.kelas && 
                currentUser.nama === oldWali.nama) {
                
                currentUser.nip = newNIP;
                currentUser.nama = newNama;
                currentUser.kelas = newKelas;
                currentUser.wa = newWA;
                
                // Update dashboard display
                const waliNameEl = document.getElementById('waliName');
                const waliKelasInfoEl = document.getElementById('waliKelasInfo');
                if (waliNameEl) waliNameEl.textContent = currentUser.nama;
                if (waliKelasInfoEl) waliKelasInfoEl.textContent = currentUser.kelas;
            }
            
            populateWaliKelasTable();
            updateMonitoringKelas(); // Update monitoring after edit
            saveDataToStorage();
            closeEditWaliModal();
            alert('Data wali kelas berhasil diupdate!');
            
            // Reset selection
            document.getElementById('selectWaliKelas').value = '';
        }

        function closeEditWaliModal() {
            const modal = document.getElementById('editWaliModal');
            if (modal) {
                modal.remove();
            }
        }

        function resetSelectedWaliPassword() {
            const selectWali = document.getElementById('selectWaliKelas');
            const selectedIndex = selectWali.value;
            
            if (!selectedIndex || selectedIndex === '') {
                alert('Silakan pilih wali kelas terlebih dahulu!');
                return;
            }
            
            const index = parseInt(selectedIndex);
            const wali = waliKelasData[index];
            
            if (!wali) {
                alert('Data wali kelas tidak ditemukan!');
                return;
            }
            
            // Show confirmation modal
            showResetPasswordModal(index, wali);
        }

        function showResetPasswordModal(index, wali) {
            const modal = document.createElement('div');
            modal.id = 'resetPasswordModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">üîë Reset Password</h3>
                        <p class="text-gray-600 mb-4">Yakin ingin reset password untuk:</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <p class="font-semibold text-gray-800">${wali.nama}</p>
                            <p class="text-sm text-gray-600">NIP: ${wali.nip} | Kelas: ${wali.kelas}</p>
                        </div>
                        <p class="text-sm text-gray-600 mb-6">Password akan direset ke: <span class="font-mono bg-gray-100 px-2 py-1 rounded">guru123</span></p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="confirmResetPassword(${index})" class="flex-1 bg-yellow-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                            üîÑ Ya, Reset Password
                        </button>
                        <button onclick="closeResetPasswordModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmResetPassword(index) {
            const wali = waliKelasData[index];
            
            // Update password directly in the array
            waliKelasData[index] = {
                ...waliKelasData[index],
                password: 'guru123'
            };
            
            // Update current user if resetting own password
            if (currentUser && currentRole === 'wali' && 
                currentUser.nip === wali.nip && 
                currentUser.kelas === wali.kelas &&
                currentUser.nama === wali.nama) {
                currentUser.password = 'guru123';
            }
            
            saveDataToStorage();
            closeResetPasswordModal();
            alert(`Password ${wali.nama} berhasil direset ke "guru123"!`);
            
            // Reset selection
            document.getElementById('selectWaliKelas').value = '';
        }

        function closeResetPasswordModal() {
            const modal = document.getElementById('resetPasswordModal');
            if (modal) {
                modal.remove();
            }
        }

        function deleteSelectedWali() {
            const selectWali = document.getElementById('selectWaliKelas');
            const selectedIndex = selectWali.value;
            
            if (!selectedIndex || selectedIndex === '') {
                alert('Silakan pilih wali kelas terlebih dahulu!');
                return;
            }
            
            const index = parseInt(selectedIndex);
            const wali = waliKelasData[index];
            
            if (!wali) {
                alert('Data wali kelas tidak ditemukan!');
                return;
            }
            
            // Show delete confirmation modal
            showDeleteWaliModal(index, wali);
        }

        function showDeleteWaliModal(index, wali) {
            // Check if there are students in this class
            const siswaKelas = Object.values(siswaData).filter(s => s.kelas === wali.kelas);
            
            const modal = document.createElement('div');
            modal.id = 'deleteWaliModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">üóëÔ∏è Hapus Wali Kelas</h3>
                        <p class="text-gray-600 mb-4">Yakin ingin menghapus wali kelas:</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="font-semibold text-gray-800">${wali.nama}</p>
                            <p class="text-sm text-gray-600">NIP: ${wali.nip} | Kelas: ${wali.kelas}</p>
                        </div>
                        ${siswaKelas.length > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>‚ö†Ô∏è Perhatian:</strong> Ada ${siswaKelas.length} siswa di kelas ini. 
                                    Siswa akan tetap ada tapi tanpa wali kelas.
                                </p>
                            </div>
                        ` : ''}
                        <p class="text-sm text-red-600 font-medium">Tindakan ini tidak dapat dibatalkan!</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="confirmDeleteWali(${index})" class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            üóëÔ∏è Ya, Hapus
                        </button>
                        <button onclick="closeDeleteWaliModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmDeleteWali(index) {
            const wali = waliKelasData[index];
            const deletedWaliName = wali.nama;
            
            // Remove wali from array
            waliKelasData.splice(index, 1);
            
            // Update stats if elements exist
            const totalWaliElement = document.getElementById('totalWaliKelas');
            if (totalWaliElement) {
                totalWaliElement.textContent = waliKelasData.length;
            }
            
            populateWaliKelasTable();
            updateMonitoringKelas(); // Update monitoring after delete
            saveDataToStorage();
            closeDeleteWaliModal();
            alert(`Wali kelas ${deletedWaliName} berhasil dihapus!`);
            
            // Reset selection
            document.getElementById('selectWaliKelas').value = '';
        }

        function closeDeleteWaliModal() {
            const modal = document.getElementById('deleteWaliModal');
            if (modal) {
                modal.remove();
            }
        }

        function downloadWaliTemplate() {
            try {
                // Create comprehensive template data with more examples
                const template = [
                    ['NIP', 'Nama', 'Kelas', 'No. WhatsApp'],
                    ['196701011990031001', 'Rahmah Saniah, S.Pd', '7A', '08123456789'],
                    ['196702021990032002', 'Nurlina, S.Pd', '7B', '08123456790'],
                    ['196703031990033003', 'Dian Putri Safrine, S.Pd', '7C', '08123456791'],
                    ['196704041990034004', 'Syarifah Hadijah, S.Pd', '7D', '08123456792'],
                    ['196705051990035005', 'Arinta Kusumaningrum, S.Pd', '7E', '08123456793'],
                    ['196706061990036006', 'Maryam, S.Pd', '7F', '08123456794']
                ];
                
                // Create workbook and worksheet
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template Wali Kelas');
                
                // Set column widths for better readability
                ws['!cols'] = [
                    {wch: 20}, // NIP
                    {wch: 30}, // Nama
                    {wch: 10}, // Kelas
                    {wch: 18}  // No. WhatsApp
                ];
                
                // Generate and download file
                const fileName = `template_wali_kelas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ Template Wali Kelas berhasil didownload!\n\nüìã Format Template:\n‚Ä¢ NIP: 18 digit (contoh: 196701011990031001)\n‚Ä¢ Nama: Nama lengkap dengan gelar\n‚Ä¢ Kelas: 7A, 7B, 8A, 8B, 9A, 9B, dst\n‚Ä¢ No. WhatsApp: 08xxxxxxxxxx atau 62xxxxxxxxx');
            } catch (error) {
                console.error('Error downloading wali template:', error);
                alert('‚ùå Gagal mendownload template.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman\n3. Gunakan browser Chrome/Firefox terbaru');
            }
        }

        function importWaliFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let skippedCount = 0;
                    
                    // Skip header row
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1] && row[2]) {
                            // Clean and validate data - ensure NIP is string
                            const nip = String(row[0]).trim();
                            const nama = String(row[1]).trim();
                            const kelas = String(row[2]).trim();
                            let wa = row[3] ? String(row[3]).trim() : '';
                            
                            // Validate kelas format
                            const validKelas = ['7A', '7B', '7C', '7D', '7E', '7F', '8A', '8B', '8C', '8D', '8E', '8F', '9A', '9B', '9C', '9D', '9E', '9F'];
                            if (!validKelas.includes(kelas)) {
                                console.warn(`Kelas tidak valid: ${kelas} untuk ${nama}`);
                                skippedCount++;
                                continue;
                            }
                            
                            // Clean WhatsApp number
                            if (wa) {
                                // Remove all non-digit characters
                                wa = wa.replace(/\D/g, '');
                                
                                // Format Indonesian phone number
                                if (wa.startsWith('0')) {
                                    wa = '62' + wa.substring(1);
                                } else if (wa && !wa.startsWith('62')) {
                                    wa = '62' + wa;
                                }
                                
                                // Validate length
                                if (wa.length < 12 || wa.length > 15) {
                                    console.warn(`Nomor WA tidak valid untuk ${nama}: ${row[3]}`);
                                    wa = ''; // Reset to empty if invalid
                                }
                            }
                            
                            // Create new wali object with proper structure
                            const newWali = {
                                nip: nip,
                                nama: nama,
                                kelas: kelas,
                                wa: wa,
                                password: 'guru123' // Ensure password is always set
                            };
                            
                            // Check if wali already exists (by NIP or by kelas)
                            const existingByNIP = waliKelasData.findIndex(w => String(w.nip) === nip);
                            const existingByKelas = waliKelasData.findIndex(w => w.kelas === kelas);
                            
                            if (existingByNIP >= 0) {
                                // Update existing wali by NIP, preserve password if exists
                                const existingPassword = waliKelasData[existingByNIP].password || 'guru123';
                                waliKelasData[existingByNIP] = {
                                    ...newWali,
                                    password: existingPassword
                                };
                                updatedCount++;
                            } else if (existingByKelas >= 0) {
                                // Replace wali for this class, preserve password if exists
                                const existingPassword = waliKelasData[existingByKelas].password || 'guru123';
                                waliKelasData[existingByKelas] = {
                                    ...newWali,
                                    password: existingPassword
                                };
                                updatedCount++;
                            } else {
                                // Add new wali with default password
                                waliKelasData.push(newWali);
                                importedCount++;
                            }
                        } else {
                            skippedCount++;
                        }
                    }
                    
                    // Update all related displays and data
                    populateWaliKelasTable();
                    updateMonitoringKelas(); // Update monitoring with new wali data
                    loadKepalaData(); // Update dashboard stats
                    saveDataToStorage();
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Show comprehensive result message with login info
                    let message = `‚úÖ Import wali kelas selesai!\n\nüìä Ringkasan:\n`;
                    if (importedCount > 0) message += `‚Ä¢ ${importedCount} wali kelas baru ditambahkan\n`;
                    if (updatedCount > 0) message += `‚Ä¢ ${updatedCount} wali kelas diperbarui\n`;
                    if (skippedCount > 0) message += `‚Ä¢ ${skippedCount} baris dilewati (data tidak lengkap/tidak valid)\n`;
                    
                    message += `\nüîë Info Login:\n‚Ä¢ Password default: "guru123"\n‚Ä¢ Login menggunakan NIP yang diimport\n‚Ä¢ Wali kelas dapat langsung login setelah import\n\nüí° Fitur WhatsApp siap digunakan untuk wali kelas yang memiliki nomor valid!`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('Error importing wali kelas:', error);
                    alert('‚ùå Gagal mengimport data wali kelas.\n\nPastikan:\n1. File Excel sesuai template\n2. Format data benar\n3. File tidak corrupt\n4. NIP dalam format yang benar');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Siswa Management
        function populateSiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            tbody.innerHTML = '';
            
            const kelasCurrentUser = currentUser.kelas;
            const siswaDiKelas = Object.values(siswaData).filter(siswa => siswa.kelas === kelasCurrentUser);
            
            // Sort students by name alphabetically
            siswaDiKelas.sort((a, b) => a.nama.localeCompare(b.nama, 'id-ID'));
            
            siswaDiKelas.forEach((siswa, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${siswa.nisn}</td>
                    <td class="border border-gray-300 px-4 py-2">${siswa.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${siswa.wa || '-'}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="editSiswa('${siswa.nisn}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">Edit</button>
                        <button onclick="resetSiswaPassword('${siswa.nisn}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-1">Reset Password</button>
                        <button onclick="deleteSiswa('${siswa.nisn}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Hapus</button>
                    </td>
                `;
            });
            
            // Update total siswa
            document.getElementById('totalSiswaKelas').textContent = siswaDiKelas.length;
        }

        function showAddSiswaForm() {
            document.getElementById('addSiswaForm').classList.remove('hidden');
        }

        function hideAddSiswaForm() {
            document.getElementById('addSiswaForm').classList.add('hidden');
            document.getElementById('addSiswaForm').querySelector('form').reset();
        }

        function addSiswa(event) {
            event.preventDefault();
            
            const nisn = document.getElementById('newSiswaNISN').value;
            const nama = document.getElementById('newSiswaNama').value;
            const wa = document.getElementById('newSiswaWA').value;
            
            siswaData[nisn] = {
                nisn: nisn,
                nama: nama,
                wa: wa,
                kelas: currentUser.kelas,
                password: '123456',
                streak: 0,
                totalJurnal: 0
            };
            
            populateSiswaTable();
            hideAddSiswaForm();
            saveDataToStorage();
            alert('Siswa berhasil ditambahkan!');
        }

        function editSiswa(nisn) {
            const siswa = siswaData[nisn];
            if (!siswa) {
                alert('‚ùå Data siswa tidak ditemukan!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.id = 'editSiswaModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Edit Data Siswa</h3>
                        <button onclick="closeEditSiswaModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="updateSiswaData(event, '${nisn}')">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                            <input type="text" id="editSiswaNISN" value="${siswa.nisn}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="editSiswaNama" value="${siswa.nama}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp</label>
                            <input type="text" id="editSiswaWA" value="${siswa.wa || ''}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="08xxxxxxxxxx">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                üíæ Update Data
                            </button>
                            <button type="button" onclick="closeEditSiswaModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                                ‚ùå Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function updateSiswaData(event, oldNISN) {
            event.preventDefault();
            
            const newNISN = document.getElementById('editSiswaNISN').value.trim();
            const newNama = document.getElementById('editSiswaNama').value.trim();
            const newWA = document.getElementById('editSiswaWA').value.trim();
            
            if (!newNISN || !newNama) {
                alert('‚ùå NISN dan Nama harus diisi!');
                return;
            }
            
            // Check if new NISN already exists (except current)
            if (newNISN !== oldNISN && siswaData[newNISN]) {
                alert('‚ùå NISN sudah digunakan oleh siswa lain!\n\nSilakan gunakan NISN yang berbeda.');
                return;
            }
            
            const oldSiswa = siswaData[oldNISN];
            
            // If NISN changed, we need to update the key
            if (newNISN !== oldNISN) {
                // Create new entry with new NISN
                siswaData[newNISN] = {
                    ...oldSiswa,
                    nisn: newNISN,
                    nama: newNama,
                    wa: newWA
                };
                
                // Move journal data to new NISN
                if (jurnalData[oldNISN]) {
                    jurnalData[newNISN] = jurnalData[oldNISN];
                    delete jurnalData[oldNISN];
                }
                
                // Delete old entry
                delete siswaData[oldNISN];
                
                // Update current user if editing own data
                if (currentUser && currentRole === 'siswa' && 
                    currentUser.nisn === oldNISN) {
                    currentUser.nisn = newNISN;
                    currentUser.nama = newNama;
                    currentUser.wa = newWA;
                    const siswaNameElement = document.getElementById('siswaName');
                    if (siswaNameElement) {
                        siswaNameElement.textContent = currentUser.nama;
                    }
                }
            } else {
                // Just update existing data
                siswaData[oldNISN] = {
                    ...siswaData[oldNISN],
                    nama: newNama,
                    wa: newWA
                };
                
                // Update current user if editing own data
                if (currentUser && currentRole === 'siswa' && 
                    currentUser.nisn === oldNISN) {
                    currentUser.nama = newNama;
                    currentUser.wa = newWA;
                    const siswaNameElement = document.getElementById('siswaName');
                    if (siswaNameElement) {
                        siswaNameElement.textContent = currentUser.nama;
                    }
                }
            }
            
            // Refresh table and monitoring
            if (currentRole === 'wali') {
                populateSiswaTable();
                loadWaliData(); // Update stats
                updateSiswaMonitoring(); // Update monitoring
            } else if (currentRole === 'kepala') {
                updateMonitoringKelas(); // Update monitoring for kepala
            }
            
            saveDataToStorage();
            closeEditSiswaModal();
            alert('‚úÖ Data siswa berhasil diupdate!');
        }

        function closeEditSiswaModal() {
            const modal = document.getElementById('editSiswaModal');
            if (modal) {
                modal.remove();
            }
        }

        function resetSiswaPassword(nisn) {
            const siswa = siswaData[nisn];
            if (!siswa) {
                alert('‚ùå Data siswa tidak ditemukan!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            // Create reset password modal
            const modal = document.createElement('div');
            modal.id = 'resetSiswaPasswordModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">üîë Reset Password Siswa</h3>
                        <p class="text-gray-600 mb-4">Yakin ingin reset password untuk:</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <p class="font-semibold text-gray-800">${siswa.nama}</p>
                            <p class="text-sm text-gray-600">NISN: ${siswa.nisn} | Kelas: ${siswa.kelas}</p>
                        </div>
                        <p class="text-sm text-gray-600 mb-6">Password akan direset ke: <span class="font-mono bg-gray-100 px-2 py-1 rounded">123456</span></p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="confirmResetSiswaPassword('${nisn}')" class="flex-1 bg-yellow-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                            üîÑ Ya, Reset Password
                        </button>
                        <button onclick="closeResetSiswaPasswordModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmResetSiswaPassword(nisn) {
            const siswa = siswaData[nisn];
            
            // Update password directly
            siswaData[nisn] = {
                ...siswaData[nisn],
                password: '123456'
            };
            
            // Update current user if resetting own password
            if (currentUser && currentRole === 'siswa' && 
                currentUser.nisn === nisn) {
                currentUser.password = '123456';
            }
            
            saveDataToStorage();
            closeResetSiswaPasswordModal();
            alert(`‚úÖ Password ${siswa.nama} berhasil direset ke "123456"!\n\nüìù Siswa dapat login dengan password baru ini.`);
        }

        function closeResetSiswaPasswordModal() {
            const modal = document.getElementById('resetSiswaPasswordModal');
            if (modal) {
                modal.remove();
            }
        }

        function deleteSiswa(nisn) {
            const siswa = siswaData[nisn];
            if (!siswa) {
                alert('‚ùå Data siswa tidak ditemukan!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            // Count journals to be deleted
            const jurnalCount = jurnalData[nisn] ? Object.keys(jurnalData[nisn]).length : 0;
            
            // Create delete confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteSiswaModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">üóëÔ∏è Hapus Data Siswa</h3>
                        <p class="text-gray-600 mb-4">Yakin ingin menghapus siswa:</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="font-semibold text-gray-800">${siswa.nama}</p>
                            <p class="text-sm text-gray-600">NISN: ${siswa.nisn} | Kelas: ${siswa.kelas}</p>
                        </div>
                        
                        ${jurnalCount > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>‚ö†Ô∏è Perhatian:</strong> Siswa ini memiliki ${jurnalCount} jurnal syukur yang akan ikut terhapus!
                                </p>
                            </div>
                        ` : `
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
                                <p class="text-sm text-blue-800">
                                    üìù Siswa ini belum memiliki jurnal syukur.
                                </p>
                            </div>
                        `}
                        
                        <p class="text-sm text-red-600 font-medium">Tindakan ini tidak dapat dibatalkan!</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="confirmDeleteSiswa('${nisn}')" class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            üóëÔ∏è Ya, Hapus Siswa
                        </button>
                        <button onclick="closeDeleteSiswaModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmDeleteSiswa(nisn) {
            const siswa = siswaData[nisn];
            const deletedSiswaName = siswa.nama;
            const jurnalCount = jurnalData[nisn] ? Object.keys(jurnalData[nisn]).length : 0;
            
            // Delete siswa data
            delete siswaData[nisn];
            
            // Also delete journal data
            if (jurnalData[nisn]) {
                delete jurnalData[nisn];
            }
            
            // Refresh table and monitoring
            if (currentRole === 'wali') {
                populateSiswaTable();
                loadWaliData(); // Update stats
                updateSiswaMonitoring(); // Update monitoring
            } else if (currentRole === 'kepala') {
                updateMonitoringKelas(); // Update monitoring for kepala
                loadKepalaData(); // Update stats
            }
            
            saveDataToStorage();
            closeDeleteSiswaModal();
            
            let message = `‚úÖ Siswa ${deletedSiswaName} berhasil dihapus!`;
            if (jurnalCount > 0) {
                message += `\n\nüìä Data yang dihapus:\n‚Ä¢ Data siswa\n‚Ä¢ ${jurnalCount} jurnal syukur`;
            }
            alert(message);
        }

        function closeDeleteSiswaModal() {
            const modal = document.getElementById('deleteSiswaModal');
            if (modal) {
                modal.remove();
            }
        }

        function downloadSiswaTemplate() {
            try {
                // Create comprehensive student template data
                const template = [
                    ['NISN', 'Nama', 'No. WhatsApp'],
                    ['0123456789', 'Ahmad Budi Santoso', '08123456789'],
                    ['0123456790', 'Siti Aisyah Putri', '08123456790'],
                    ['0123456791', 'Muhammad Rizki Pratama', '08123456791'],
                    ['0123456792', 'Fatimah Zahra', '08123456792'],
                    ['0123456793', 'Dimas Arya Wijaya', '08123456793'],
                    ['0123456794', 'Nur Halimah', '08123456794'],
                    ['0123456795', 'Bayu Setiawan', '08123456795'],
                    ['0123456796', 'Indira Sari', '08123456796'],
                    ['0123456797', 'Fajar Ramadhan', '08123456797'],
                    ['0123456798', 'Dewi Lestari', '08123456798'],
                    ['0123456799', 'Andi Pratama', '08123456799'],
                    ['0123456800', 'Sari Wulandari', '08123456800'],
                    ['0123456801', 'Reza Firmansyah', '08123456801'],
                    ['0123456802', 'Maya Anggraini', '08123456802'],
                    ['0123456803', 'Hendra Gunawan', '08123456803'],
                    ['0123456804', 'Rina Marlina', '08123456804'],
                    ['0123456805', 'Agus Salim', '08123456805'],
                    ['0123456806', 'Lina Handayani', '08123456806'],
                    ['0123456807', 'Budi Hartono', '08123456807'],
                    ['0123456808', 'Sinta Dewi', '08123456808'],
                    ['0123456809', 'Eko Prasetyo', '08123456809'],
                    ['0123456810', 'Ratna Sari', '08123456810'],
                    ['0123456811', 'Joko Susilo', '08123456811'],
                    ['0123456812', 'Ani Suryani', '08123456812'],
                    ['0123456813', 'Dedi Kurniawan', '08123456813'],
                    ['0123456814', 'Wati Rahayu', '08123456814'],
                    ['0123456815', 'Ari Wibowo', '08123456815'],
                    ['0123456816', 'Sari Utami', '08123456816'],
                    ['0123456817', 'Toni Setiawan', '08123456817'],
                    ['0123456818', 'Lia Permata', '08123456818']
                ];
                
                // Create workbook and worksheet
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template Siswa');
                
                // Set column widths for better readability
                ws['!cols'] = [
                    {wch: 15}, // NISN
                    {wch: 25}, // Nama
                    {wch: 18}  // No. WhatsApp
                ];
                
                // Generate and download file
                const kelasInfo = currentUser && currentUser.kelas ? `_${currentUser.kelas}` : '';
                const fileName = `template_siswa${kelasInfo}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ Template Siswa berhasil didownload!\n\nüìã Format Template:\n‚Ä¢ NISN: 10 digit (contoh: 0123456789)\n‚Ä¢ Nama: Nama lengkap siswa\n‚Ä¢ No. WhatsApp: 08xxxxxxxxxx atau 62xxxxxxxxx\n\nüìù Catatan: Siswa otomatis masuk ke kelas Anda saat import');
            } catch (error) {
                console.error('Error downloading siswa template:', error);
                alert('‚ùå Gagal mendownload template.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman\n3. Gunakan browser Chrome/Firefox terbaru');
            }
        }

        function importSiswaFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let skippedCount = 0;
                    
                    // Skip header row
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1]) {
                            // Clean and validate data - ensure NISN is string
                            const nisn = String(row[0]).trim();
                            const nama = String(row[1]).trim();
                            let wa = row[2] ? String(row[2]).trim() : '';
                            
                            // Clean WhatsApp number
                            if (wa) {
                                // Remove all non-digit characters
                                wa = wa.replace(/\D/g, '');
                                
                                // Format Indonesian phone number
                                if (wa.startsWith('0')) {
                                    wa = '62' + wa.substring(1);
                                } else if (wa && !wa.startsWith('62')) {
                                    wa = '62' + wa;
                                }
                                
                                // Validate length
                                if (wa.length < 12 || wa.length > 15) {
                                    console.warn(`Nomor WA tidak valid untuk ${nama}: ${row[2]}`);
                                    wa = ''; // Reset to empty if invalid
                                }
                            }
                            
                            // Create new siswa object with proper structure
                            const newSiswa = {
                                nisn: nisn,
                                nama: nama,
                                wa: wa,
                                kelas: currentUser.kelas,
                                password: '123456', // Ensure password is always set
                                streak: 0,
                                totalJurnal: 0
                            };
                            
                            // Check if siswa already exists
                            if (siswaData[nisn]) {
                                // Update existing siswa, preserve password and stats if exists
                                const existingPassword = siswaData[nisn].password || '123456';
                                const existingStreak = siswaData[nisn].streak || 0;
                                const existingTotalJurnal = siswaData[nisn].totalJurnal || 0;
                                siswaData[nisn] = {
                                    ...newSiswa,
                                    password: existingPassword,
                                    streak: existingStreak,
                                    totalJurnal: existingTotalJurnal
                                };
                                updatedCount++;
                            } else {
                                // Add new siswa with default password - ensure it's properly activated
                                siswaData[nisn] = {
                                    ...newSiswa,
                                    password: '123456' // Explicitly set password for login
                                };
                                importedCount++;
                            }
                        } else {
                            skippedCount++;
                        }
                    }
                    
                    // Update all related displays and data
                    populateSiswaTable();
                    updateSiswaMonitoring(); // Update monitoring with new siswa data
                    loadWaliData(); // Update dashboard stats
                    saveDataToStorage();
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Show comprehensive result message with login info
                    let message = `‚úÖ Import siswa selesai!\n\nüìä Ringkasan:\n`;
                    if (importedCount > 0) message += `‚Ä¢ ${importedCount} siswa baru ditambahkan\n`;
                    if (updatedCount > 0) message += `‚Ä¢ ${updatedCount} siswa diperbarui\n`;
                    if (skippedCount > 0) message += `‚Ä¢ ${skippedCount} baris dilewati (data tidak lengkap)\n`;
                    
                    message += `\nüîë Info Login:\n‚Ä¢ Password default: "123456"\n‚Ä¢ Login menggunakan NISN yang diimport\n‚Ä¢ Siswa dapat langsung login setelah import\n‚Ä¢ Kelas otomatis: ${currentUser.kelas}\n\nüí° Fitur WhatsApp siap digunakan untuk siswa yang memiliki nomor valid!`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('Error importing siswa:', error);
                    alert('‚ùå Gagal mengimport data siswa.\n\nPastikan:\n1. File Excel sesuai template\n2. Format data benar\n3. File tidak corrupt\n4. NISN dalam format yang benar');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Journal Management
        function submitJurnal(event) {
            event.preventDefault();
            
            const today = new Date().toISOString().split('T')[0];
            const syukur1 = document.getElementById('syukur1').value.trim();
            const syukur2 = document.getElementById('syukur2').value.trim();
            const syukur3 = document.getElementById('syukur3').value.trim();
            
            // Validate input
            if (!syukur1 || !syukur2 || !syukur3) {
                alert('‚ùå Harap isi semua field jurnal syukur!\n\nSetiap field harus diisi untuk melengkapi jurnal harian Anda.');
                return;
            }
            
            // Initialize journal data if not exists
            if (!jurnalData[currentUser.nisn]) {
                jurnalData[currentUser.nisn] = {};
            }
            
            // Check if already submitted today - show notification if already exists
            const isUpdate = jurnalData[currentUser.nisn][today] ? true : false;
            
            if (isUpdate) {
                // Show already submitted notification
                showAlreadySubmittedNotification();
                return;
            }
            
            // Save to local storage
            jurnalData[currentUser.nisn][today] = {
                syukur1: syukur1,
                syukur2: syukur2,
                syukur3: syukur3,
                timestamp: new Date().toISOString()
            };
            
            // Update student stats
            currentUser.totalJurnal = Object.keys(jurnalData[currentUser.nisn]).length;
            updateStreak();
            
            // Update siswa data in main storage
            if (siswaData[currentUser.nisn]) {
                siswaData[currentUser.nisn].totalJurnal = currentUser.totalJurnal;
                siswaData[currentUser.nisn].streak = currentUser.streak;
            }
            
            // Save to storage first
            saveDataToStorage();
            
            // Update monitoring displays immediately for all wali kelas
            updateAllMonitoringDisplays();
            
            // Show immediate success notification
            showJurnalSuccessNotification(isUpdate);
            
            // Send to Google Sheets with better error handling
            sendToGoogleSheets({
                nisn: currentUser.nisn,
                nama: currentUser.nama,
                kelas: currentUser.kelas,
                tanggal: today,
                syukur1: syukur1,
                syukur2: syukur2,
                syukur3: syukur3
            }).then(() => {
                console.log('‚úÖ Data berhasil dikirim ke Google Sheets');
            }).catch(error => {
                console.error('‚ö†Ô∏è Gagal mengirim ke Google Sheets:', error);
                // Data tetap tersimpan lokal meskipun gagal ke Google Sheets
            });
            
            // Reset form
            document.getElementById('jurnalForm').reset();
            
            // Update stats
            loadSiswaData();
            checkAchievements();
            
            // Auto redirect to welcome after 3 seconds
            setTimeout(() => {
                showSiswaSection('siswaWelcomeSection');
            }, 3000);
        }

        function showJurnalSuccessNotification(isUpdate) {
            // Create success notification modal
            const modal = document.createElement('div');
            modal.id = 'jurnalSuccessModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md text-center animate-fade-in">
                    <div class="w-20 h-20 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-green-800 mb-4">
                        ${isUpdate ? '‚úÖ Jurnal Diperbarui!' : 'üéâ Jurnal Tersimpan!'}
                    </h3>
                    
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-6">
                        <p class="text-green-800 mb-2">
                            <strong>${isUpdate ? 'Jurnal hari ini berhasil diperbarui!' : 'Jurnal syukur hari ini berhasil disimpan!'}</strong>
                        </p>
                        <div class="text-sm text-green-700">
                            <p>üìÖ Tanggal: ${new Date().toLocaleDateString('id-ID', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}</p>
                            <p>‚è∞ Waktu: ${new Date().toLocaleTimeString('id-ID')}</p>
                            <p>üìä Total jurnal Anda: ${currentUser.totalJurnal}</p>
                            <p>üî• Streak: ${currentUser.streak || 0} hari berturut-turut</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
                        <p class="text-blue-800 text-sm">
                            <strong>üíæ Status Penyimpanan:</strong><br>
                            ‚úÖ Tersimpan di perangkat Anda<br>
                            üì§ Sedang dikirim ke Google Drive...
                        </p>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">
                            Terima kasih telah konsisten menulis jurnal syukur! 
                            Semoga berkah selalu menyertai Anda. üåü
                        </p>
                        
                        <button onclick="closeJurnalSuccessModal()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                            Alhamdulillah! ü§≤
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto close after 5 seconds
            setTimeout(() => {
                closeJurnalSuccessModal();
            }, 5000);
        }

        function closeJurnalSuccessModal() {
            const modal = document.getElementById('jurnalSuccessModal');
            if (modal) {
                modal.remove();
            }
        }

        function showAlreadySubmittedNotification() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const userJurnal = jurnalData[currentUser.nisn][todayStr];
            
            // Create already submitted notification modal
            const modal = document.createElement('div');
            modal.id = 'alreadySubmittedModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md text-center animate-fade-in">
                    <div class="w-20 h-20 mx-auto mb-6 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">
                        ‚úÖ Sudah Mengisi Jurnal Hari Ini!
                    </h3>
                    
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
                        <p class="text-blue-800 mb-2">
                            <strong>Anda sudah mengisi jurnal syukur hari ini!</strong>
                        </p>
                        <div class="text-sm text-blue-700">
                            <p>üìÖ Tanggal: ${today.toLocaleDateString('id-ID', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}</p>
                            <p>‚è∞ Waktu pengisian: ${new Date(userJurnal.timestamp).toLocaleTimeString('id-ID')}</p>
                            <p>üìä Total jurnal Anda: ${currentUser.totalJurnal}</p>
                            <p>üî• Streak: ${currentUser.streak || 0} hari berturut-turut</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
                        <p class="text-yellow-800 text-sm">
                            <strong>üìù Aturan Jurnal Syukur:</strong><br>
                            Setiap siswa hanya boleh mengisi jurnal syukur <strong>sekali sehari</strong>. 
                            Silakan kembali besok untuk menulis jurnal syukur yang baru! üåÖ
                        </p>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-6">
                        <p class="text-green-800 text-sm">
                            <strong>üí° Jurnal Anda hari ini:</strong>
                        </p>
                        <div class="text-left text-sm text-green-700 mt-2 space-y-1">
                            <p><strong>1.</strong> ${userJurnal.syukur1}</p>
                            <p><strong>2.</strong> ${userJurnal.syukur2}</p>
                            <p><strong>3.</strong> ${userJurnal.syukur3}</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">
                            Terima kasih sudah konsisten! Sampai jumpa besok untuk jurnal syukur yang baru! üåü
                        </p>
                        
                        <button onclick="closeAlreadySubmittedModal()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            Baik, Sampai Besok! üëã
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto close after 8 seconds
            setTimeout(() => {
                closeAlreadySubmittedModal();
            }, 8000);
        }

        function closeAlreadySubmittedModal() {
            const modal = document.getElementById('alreadySubmittedModal');
            if (modal) {
                modal.remove();
            }
        }

        function checkTodayJournalStatus() {
            const today = new Date().toISOString().split('T')[0];
            const userJurnals = jurnalData[currentUser.nisn] || {};
            const todayJurnal = userJournals[today];
            
            const alreadySubmittedNotice = document.getElementById('alreadySubmittedNotice');
            const jurnalForm = document.getElementById('jurnalForm');
            const todayJurnalPreview = document.getElementById('todayJurnalPreview');
            
            if (todayJurnal) {
                // Show already submitted notice
                alreadySubmittedNotice.classList.remove('hidden');
                jurnalForm.classList.add('hidden');
                
                // Display today's journal
                const submissionTime = new Date(todayJurnal.timestamp).toLocaleTimeString('id-ID');
                todayJurnalPreview.innerHTML = `
                    <div class="mb-3">
                        <p class="text-sm text-gray-600 mb-2">‚è∞ Diisi pada: ${submissionTime}</p>
                    </div>
                    <div class="space-y-3">
                        <div class="border-l-4 border-blue-400 pl-4">
                            <p class="text-sm font-medium text-blue-800">1. Hal pertama yang disyukuri:</p>
                            <p class="text-gray-700">${todayJurnal.syukur1}</p>
                        </div>
                        <div class="border-l-4 border-green-400 pl-4">
                            <p class="text-sm font-medium text-green-800">2. Hal kedua yang disyukuri:</p>
                            <p class="text-gray-700">${todayJurnal.syukur2}</p>
                        </div>
                        <div class="border-l-4 border-purple-400 pl-4">
                            <p class="text-sm font-medium text-purple-800">3. Hal ketiga yang disyukuri:</p>
                            <p class="text-gray-700">${todayJurnal.syukur3}</p>
                        </div>
                    </div>
                `;
            } else {
                // Show journal form
                alreadySubmittedNotice.classList.add('hidden');
                jurnalForm.classList.remove('hidden');
            }
        }

        function sendToGoogleSheets(data) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxX_6DdxWq-EMnYt6-cOJk6pw43Tv3fwuMaCae9oMi--DCyZT50TRhn58AhRj3O1kvb/exec';
            
            return new Promise((resolve, reject) => {
                // Show sending status
                updateGoogleSheetsStatus('sending');
                
                fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for Google Apps Script
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    // With no-cors mode, we can't read the response
                    // But if no error is thrown, we assume success
                    console.log('‚úÖ Data berhasil dikirim ke Google Sheets');
                    updateGoogleSheetsStatus('success');
                    resolve(true);
                })
                .catch(error => {
                    console.error('‚ö†Ô∏è Error mengirim data ke Google Sheets:', error);
                    updateGoogleSheetsStatus('error');
                    reject(error);
                });
                
                // Fallback timeout - assume success after 10 seconds
                setTimeout(() => {
                    console.log('üì§ Google Sheets request timeout - assuming success');
                    updateGoogleSheetsStatus('success');
                    resolve(true);
                }, 10000);
            });
        }

        function updateGoogleSheetsStatus(status) {
            const statusElement = document.querySelector('#jurnalSuccessModal .bg-blue-50 p');
            if (!statusElement) return;
            
            switch(status) {
                case 'sending':
                    statusElement.innerHTML = `
                        <strong>üíæ Status Penyimpanan:</strong><br>
                        ‚úÖ Tersimpan di perangkat Anda<br>
                        üì§ Sedang mengirim ke Google Drive...
                    `;
                    break;
                case 'success':
                    statusElement.innerHTML = `
                        <strong>üíæ Status Penyimpanan:</strong><br>
                        ‚úÖ Tersimpan di perangkat Anda<br>
                        ‚úÖ Berhasil dikirim ke Google Drive!
                    `;
                    statusElement.parentElement.className = 'bg-green-50 border border-green-200 p-4 rounded-lg mb-6';
                    break;
                case 'error':
                    statusElement.innerHTML = `
                        <strong>üíæ Status Penyimpanan:</strong><br>
                        ‚úÖ Tersimpan di perangkat Anda<br>
                        ‚ö†Ô∏è Gagal mengirim ke Google Drive (data tetap aman)
                    `;
                    statusElement.parentElement.className = 'bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6';
                    break;
            }
        }

        function updateStreak() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const userJurnals = jurnalData[currentUser.nisn] || {};
            
            if (userJurnals[todayStr]) {
                if (userJurnals[yesterdayStr]) {
                    currentUser.streak = (currentUser.streak || 0) + 1;
                } else {
                    currentUser.streak = 1;
                }
            }
        }

        function checkAchievements() {
            const streak = currentUser.streak || 0;
            const achievementEl = document.getElementById('achievementNotification');
            const achievementText = document.getElementById('achievementText');
            
            let message = '';
            
            if (streak >= 7 && streak < 14) {
                message = `Luar biasa! Anda telah aktif menulis jurnal syukur selama ${streak} hari berturut-turut! Terus pertahankan semangat ini! üåü`;
            } else if (streak >= 14 && streak < 21) {
                message = `Hebat sekali! ${streak} hari berturut-turut adalah pencapaian yang membanggakan! Anda semakin dekat dengan kebiasaan positif! üéâ`;
            } else if (streak >= 21 && streak < 28) {
                message = `Menakjubkan! ${streak} hari berturut-turut menunjukkan dedikasi luar biasa! Anda sedang membangun karakter yang kuat! üèÜ`;
            } else if (streak >= 28) {
                message = `Fantastis! ${streak} hari berturut-turut adalah prestasi yang sangat membanggakan! Anda adalah teladan bagi teman-teman! üëë`;
            }
            
            if (message) {
                achievementText.textContent = message;
                achievementEl.classList.remove('hidden');
            } else {
                achievementEl.classList.add('hidden');
            }
        }

        function checkTestimonyEligibility() {
            const userJurnals = jurnalData[currentUser.nisn] || {};
            const journalDates = Object.keys(userJurnals).sort();
            
            // Check if user has been active for 3 months (90 days)
            if (journalDates.length >= 90) {
                const testimonySection = document.getElementById('testimonySection');
                testimonySection.classList.remove('hidden');
            }
        }

        function submitTestimony() {
            const testimony = document.getElementById('testimonyText').value;
            if (!testimony.trim()) {
                alert('Silakan tulis testimoni Anda terlebih dahulu.');
                return;
            }
            
            // Save testimony (in real app, this would be sent to server)
            const testimonyData = {
                nisn: currentUser.nisn,
                nama: currentUser.nama,
                kelas: currentUser.kelas,
                testimony: testimony,
                date: new Date().toISOString()
            };
            
            // For demo, just show success message
            alert('Terima kasih telah berbagi testimoni Anda! Pengalaman Anda akan menginspirasi teman-teman lain.');
            document.getElementById('testimonyText').value = '';
        }

        // Monitoring and Reporting
        function updateMonitoringKelas() {
            const grid = document.getElementById('kelasMonitoringGrid');
            grid.innerHTML = '';
            
            const kelasNames = ['7A', '7B', '7C', '7D', '7E', '7F', '8A', '8B', '8C', '8D', '8E', '8F', '9A', '9B', '9C', '9D', '9E', '9F'];
            
            kelasNames.forEach(kelas => {
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelas);
                const totalSiswa = siswaKelas.length;
                const aktifHariIni = siswaKelas.filter(s => {
                    const today = new Date().toISOString().split('T')[0];
                    return jurnalData[s.nisn] && jurnalData[s.nisn][today];
                }).length;
                
                const persentase = totalSiswa > 0 ? Math.round((aktifHariIni / totalSiswa) * 100) : 0;
                
                // Find wali kelas for this class
                const waliKelas = waliKelasData.find(w => w.kelas === kelas);
                const hasWaliWA = waliKelas && waliKelas.wa && waliKelas.wa.trim() !== '';
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-lg">Kelas ${kelas}</h3>
                        <span class="text-xs px-2 py-1 rounded-full ${persentase >= 80 ? 'bg-green-100 text-green-800' : persentase >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${persentase >= 80 ? 'üéâ Excellent' : persentase >= 60 ? 'üëç Good' : 'üí™ Need Focus'}
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progress Hari Ini</span>
                            <span class="font-semibold">${persentase}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r ${persentase >= 80 ? 'from-green-500 to-green-600' : persentase >= 60 ? 'from-yellow-500 to-yellow-600' : 'from-red-500 to-red-600'} h-3 rounded-full transition-all duration-300" style="width: ${persentase}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold text-gray-800">${aktifHariIni}</span>/${totalSiswa} siswa aktif
                        </p>
                        <div class="text-xs text-gray-500">
                            ${waliKelas ? `üë©‚Äçüè´ ${waliKelas.nama.split(',')[0]}` : '‚ùå Belum ada wali'}
                        </div>
                    </div>
                    
                    <div class="border-t pt-3">
                        ${hasWaliWA ? `
                            <button onclick="kirimLaporanKeWali('${kelas}')" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span>üì± Kirim ke Wali Kelas</span>
                            </button>
                        ` : `
                            <div class="w-full bg-gray-100 text-gray-500 py-2 px-4 rounded-lg text-center text-sm">
                                ${waliKelas ? 'üì± Wali belum ada WhatsApp' : '‚ùå Belum ada wali kelas'}
                            </div>
                        `}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Individual class WhatsApp function
        function kirimLaporanKeWali(kelas) {
            const waliKelas = waliKelasData.find(w => w.kelas === kelas);
            
            if (!waliKelas) {
                alert(`‚ùå Wali kelas untuk kelas ${kelas} tidak ditemukan!\n\nSilakan tambahkan wali kelas terlebih dahulu di menu "Kelola Wali Kelas".`);
                return;
            }
            
            if (!waliKelas.wa || waliKelas.wa.trim() === '') {
                alert(`‚ùå Wali kelas ${waliKelas.nama} belum memiliki nomor WhatsApp!\n\nSilakan update nomor WhatsApp di menu "Kelola Wali Kelas".`);
                return;
            }
            
            // Show confirmation modal for individual class
            showWAConfirmationModal([waliKelas], kelas);
        }
        
        // Mass WhatsApp function for all classes
        function kirimLaporanKeSemuaWali() {
            const waliDenganWA = waliKelasData.filter(w => w.wa && w.wa.trim() !== '');
            
            if (waliDenganWA.length === 0) {
                alert('‚ùå Tidak ada wali kelas dengan nomor WhatsApp!\n\nSilakan tambahkan nomor WhatsApp wali kelas terlebih dahulu di menu "Kelola Wali Kelas".');
                return;
            }
            
            // Show confirmation modal for all classes
            showWAConfirmationModal(waliKelasData, 'all');
        }

        function showWAConfirmationModal(targetWali, kelas) {
            const modal = document.createElement('div');
            modal.id = 'waConfirmationModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            
            // Count valid WhatsApp numbers
            const waliDenganWA = targetWali.filter(w => w.wa && w.wa.trim() !== '');
            const waliTanpaWA = targetWali.filter(w => !w.wa || w.wa.trim() === '');
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">üì± Kirim Laporan WhatsApp</h3>
                        <p class="text-gray-600 mb-4">Kirim laporan jurnal syukur ke ${kelas === 'all' ? 'semua wali kelas' : `wali kelas ${kelas}`}?</p>
                        
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
                            <p class="text-sm text-blue-800 mb-2"><strong>üìä Ringkasan Pengiriman:</strong></p>
                            <ul class="text-sm text-blue-700 text-left">
                                <li>‚Ä¢ ${waliDenganWA.length} wali kelas dengan WhatsApp</li>
                                <li>‚Ä¢ ${targetWali.length} total wali kelas</li>
                                <li>‚Ä¢ Laporan aktivitas hari ini</li>
                            </ul>
                        </div>
                        
                        ${waliTanpaWA.length > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                                <p class="text-sm text-yellow-800 mb-2"><strong>‚ö†Ô∏è Wali tanpa WhatsApp:</strong></p>
                                <ul class="text-sm text-yellow-700 text-left max-h-20 overflow-y-auto">
                                    ${waliTanpaWA.map(w => `<li>‚Ä¢ ${w.nama} (${w.kelas})</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <p class="text-sm text-gray-600">Setiap chat WhatsApp akan terbuka secara otomatis.</p>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="executeWASending('${kelas}')" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors text-sm">
                            üì± Kirim Otomatis
                        </button>
                        <button onclick="showManualWAOption('${kelas}')" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm">
                            üìã Lihat Manual
                        </button>
                        <button onclick="closeWAConfirmationModal()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-600 transition-colors text-sm">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function executeWASending(kelas) {
            let targetWali = [];
            if (kelas === 'all') {
                targetWali = waliKelasData.slice();
            } else {
                targetWali = waliKelasData.filter(w => w.kelas === kelas);
            }
            
            let pesanTerkirim = 0;
            let waliTanpaWA = [];
            let waliGagal = [];
            
            targetWali.forEach((wali, index) => {
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === wali.kelas);
                const totalSiswa = siswaKelas.length;
                const aktifHariIni = siswaKelas.filter(s => {
                    const today = new Date().toISOString().split('T')[0];
                    return jurnalData[s.nisn] && jurnalData[s.nisn][today];
                }).length;
                
                const persentase = totalSiswa > 0 ? Math.round((aktifHariIni / totalSiswa) * 100) : 0;
                const tanggal = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const pesan = `üè´ *LAPORAN JURNAL SYUKUR*
üìÖ ${tanggal}
üë©‚Äçüè´ Wali Kelas: ${wali.nama}
üéì Kelas: ${wali.kelas}

üìä *Progress Hari Ini:*
‚úÖ Siswa aktif: ${aktifHariIni}/${totalSiswa} siswa
üìà Persentase: ${persentase}%

${persentase >= 80 ? 'üéâ *Luar biasa!* Kelas sangat aktif!' : 
  persentase >= 60 ? 'üëç *Bagus!* Terus tingkatkan semangat!' : 
  persentase >= 40 ? 'üí™ *Ayo semangat!* Motivasi siswa lebih aktif!' :
  'üî• *Butuh perhatian khusus!* Mari bersama motivasi siswa!'}

${totalSiswa === 0 ? 'üìù *Catatan:* Belum ada siswa terdaftar di kelas ini.' : ''}

Terima kasih atas dedikasi dan bimbingan Anda! üôè

_Kepala Sekolah_
_SMP Negeri 23 Balikpapan_
_üåü SPENDUGA HEBAT üåü_`;
                
                // Check if wali has WhatsApp number
                if (!wali.wa || wali.wa.trim() === '') {
                    waliTanpaWA.push(`${wali.nama} (${wali.kelas})`);
                    return;
                }
                
                // Clean and validate phone number
                let cleanWA = wali.wa.toString().replace(/\D/g, ''); // Remove non-digits
                
                if (!cleanWA || cleanWA.length < 10) {
                    waliGagal.push(`${wali.nama} (${wali.kelas}) - nomor tidak valid: ${wali.wa}`);
                    return;
                }
                
                // Format Indonesian phone number
                if (cleanWA.startsWith('0')) {
                    cleanWA = '62' + cleanWA.substring(1);
                } else if (!cleanWA.startsWith('62')) {
                    cleanWA = '62' + cleanWA;
                }
                
                // Validate final number format
                if (cleanWA.length < 12 || cleanWA.length > 15) {
                    waliGagal.push(`${wali.nama} (${wali.kelas}) - format nomor salah: ${wali.wa}`);
                    return;
                }
                
                // Create WhatsApp URL with better encoding and fallback options
                const encodedPesan = encodeURIComponent(pesan);
                
                // Try multiple WhatsApp URL formats with better compatibility
                const waURLs = [
                    `https://wa.me/${cleanWA}?text=${encodedPesan}`,
                    `https://web.whatsapp.com/send?phone=${cleanWA}&text=${encodedPesan}`,
                    `whatsapp://send?phone=${cleanWA}&text=${encodedPesan}`,
                    `https://api.whatsapp.com/send/?phone=${cleanWA}&text=${encodedPesan}&type=phone_number&app_absent=0`
                ];
                
                // Add progressive delay between messages to avoid overwhelming
                setTimeout(() => {
                    let success = false;
                    let lastError = '';
                    
                    // Function to try opening WhatsApp with better error detection
                    const tryOpenWhatsApp = (url, formatName) => {
                        return new Promise((resolve) => {
                            try {
                                // Create a temporary link element for better compatibility
                                const link = document.createElement('a');
                                link.href = url;
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                                
                                // Add to DOM temporarily
                                document.body.appendChild(link);
                                
                                // Try to click the link
                                link.click();
                                
                                // Remove from DOM
                                document.body.removeChild(link);
                                
                                // Check if it worked by trying window.open as fallback
                                setTimeout(() => {
                                    try {
                                        const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                                        if (newWindow) {
                                            // Close the window after a short delay to avoid popup blocking
                                            setTimeout(() => {
                                                if (!newWindow.closed) {
                                                    // Window is still open, likely successful
                                                    resolve(true);
                                                } else {
                                                    resolve(false);
                                                }
                                            }, 1000);
                                        } else {
                                            resolve(false);
                                        }
                                    } catch (popupError) {
                                        console.warn(`Popup blocked for ${formatName}:`, popupError);
                                        resolve(false);
                                    }
                                }, 500);
                                
                            } catch (error) {
                                console.error(`Error with ${formatName}:`, error);
                                lastError = error.message;
                                resolve(false);
                            }
                        });
                    };
                    
                    // Try each URL format sequentially
                    const tryFormats = async () => {
                        for (let urlIndex = 0; urlIndex < waURLs.length && !success; urlIndex++) {
                            const formatNames = ['wa.me', 'web.whatsapp.com', 'whatsapp://', 'api.whatsapp.com'];
                            const formatName = formatNames[urlIndex];
                            
                            console.log(`Trying ${formatName} for ${wali.nama}...`);
                            const result = await tryOpenWhatsApp(waURLs[urlIndex], formatName);
                            
                            if (result) {
                                success = true;
                                console.log(`‚úÖ WhatsApp opened successfully for ${wali.nama} using ${formatName}`);
                                break;
                            } else {
                                console.warn(`‚ùå ${formatName} failed for ${wali.nama}`);
                                // Small delay between attempts
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                        
                        if (!success) {
                            waliGagal.push(`${wali.nama} (${wali.kelas}) - semua format diblokir/gagal${lastError ? ` (${lastError})` : ''}`);
                        }
                    };
                    
                    tryFormats();
                }, index * 2500); // 2.5 second delay between messages
                
                pesanTerkirim++;
            });
            
            // Close modal
            closeWAConfirmationModal();
            
            // Show comprehensive result message with blocking solutions
            setTimeout(() => {
                let resultMessage = '';
                
                if (pesanTerkirim > 0) {
                    resultMessage += `‚úÖ *Berhasil!*\n${pesanTerkirim} chat WhatsApp telah dibuka untuk mengirim laporan.\n\n`;
                    resultMessage += `üì± *Petunjuk:*\n‚Ä¢ Setiap chat akan terbuka secara otomatis\n‚Ä¢ Tunggu beberapa detik antar chat\n‚Ä¢ Tekan "Send" di setiap chat WhatsApp\n\n`;
                }
                
                if (waliTanpaWA.length > 0) {
                    resultMessage += `‚ö†Ô∏è *Wali tanpa nomor WhatsApp:*\n`;
                    resultMessage += waliTanpaWA.join('\n') + '\n\n';
                }
                
                if (waliGagal.length > 0) {
                    resultMessage += `‚ùå *Gagal mengirim:*\n`;
                    resultMessage += waliGagal.join('\n') + '\n\n';
                }
                
                if (waliTanpaWA.length > 0 || waliGagal.length > 0) {
                    resultMessage += `üí° *Solusi untuk masalah WhatsApp:*\n\nüîß *Langkah Dasar:*\n‚Ä¢ Update nomor WhatsApp di menu "Kelola Wali Kelas"\n‚Ä¢ Pastikan format nomor: 08xxxxxxxxxx atau 62xxxxxxxxx\n‚Ä¢ Aktifkan popup/allow popups di browser untuk WhatsApp\n‚Ä¢ Pastikan WhatsApp Web tidak sedang login di tab lain\n\nüåê *Jika Masih Diblokir:*\n‚Ä¢ Coba browser lain (Chrome/Firefox/Edge)\n‚Ä¢ Gunakan mode incognito/private browsing\n‚Ä¢ Nonaktifkan ad blocker atau extension yang memblokir\n‚Ä¢ Refresh halaman dan coba lagi\n‚Ä¢ Coba dari jaringan internet yang berbeda\n\nüì± *Alternatif Manual:*\n‚Ä¢ Salin nomor WhatsApp dari sistem\n‚Ä¢ Buka WhatsApp di HP/komputer\n‚Ä¢ Kirim pesan manual ke nomor tersebut\n‚Ä¢ Copy-paste isi laporan dari sistem`;
                }
                
                // Add specific blocking solution message
                const hasBlockingIssues = waliGagal.some(msg => msg.includes('diblokir') || msg.includes('gagal'));
                if (hasBlockingIssues) {
                    resultMessage += `\n\nüö´ *Khusus untuk masalah koneksi/blocking:*\n‚Ä¢ Sistem sudah mencoba 4 format URL berbeda (wa.me, web.whatsapp.com, whatsapp://, api.whatsapp.com)\n‚Ä¢ Kemungkinan browser/jaringan memblokir akses WhatsApp\n‚Ä¢ Coba buka https://wa.me secara manual untuk test\n‚Ä¢ Hubungi admin IT jika masalah berlanjut\n‚Ä¢ Gunakan HP untuk kirim manual sebagai alternatif`;
                }
                
                if (resultMessage) {
                    alert(resultMessage);
                } else {
                    alert('‚ùå Tidak ada wali kelas yang dapat dihubungi!\n\nPastikan ada wali kelas dengan nomor WhatsApp yang valid.');
                }
            }, 1000); // Increased delay to allow all attempts to complete
        }

        function closeWAConfirmationModal() {
            const modal = document.getElementById('waConfirmationModal');
            if (modal) {
                modal.remove();
            }
        }

        function showManualWAOption(kelas) {
            let targetWali = [];
            if (kelas === 'all') {
                targetWali = waliKelasData.slice();
            } else {
                targetWali = waliKelasData.filter(w => w.kelas === kelas);
            }
            
            // Close current modal
            closeWAConfirmationModal();
            
            // Create manual WhatsApp modal
            const modal = document.createElement('div');
            modal.id = 'manualWAModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            
            let manualContent = '';
            targetWali.forEach(wali => {
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === wali.kelas);
                const totalSiswa = siswaKelas.length;
                const aktifHariIni = siswaKelas.filter(s => {
                    const today = new Date().toISOString().split('T')[0];
                    return jurnalData[s.nisn] && jurnalData[s.nisn][today];
                }).length;
                
                const persentase = totalSiswa > 0 ? Math.round((aktifHariIni / totalSiswa) * 100) : 0;
                const tanggal = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const pesan = `üè´ *LAPORAN JURNAL SYUKUR*
üìÖ ${tanggal}
üë©‚Äçüè´ Wali Kelas: ${wali.nama}
üéì Kelas: ${wali.kelas}

üìä *Progress Hari Ini:*
‚úÖ Siswa aktif: ${aktifHariIni}/${totalSiswa} siswa
üìà Persentase: ${persentase}%

${persentase >= 80 ? 'üéâ *Luar biasa!* Kelas sangat aktif!' : 
  persentase >= 60 ? 'üëç *Bagus!* Terus tingkatkan semangat!' : 
  persentase >= 40 ? 'üí™ *Ayo semangat!* Motivasi siswa lebih aktif!' :
  'üî• *Butuh perhatian khusus!* Mari bersama motivasi siswa!'}

${totalSiswa === 0 ? 'üìù *Catatan:* Belum ada siswa terdaftar di kelas ini.' : ''}

Terima kasih atas dedikasi dan bimbingan Anda! üôè

_Kepala Sekolah_
_SMP Negeri 23 Balikpapan_
_üåü SPENDUGA HEBAT üåü_`;
                
                manualContent += `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${wali.nama}</h4>
                                <p class="text-sm text-gray-600">Kelas ${wali.kelas}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-700">üì± ${wali.wa || 'Tidak ada nomor'}</p>
                                ${wali.wa ? `
                                    <button onclick="copyToClipboard('${wali.wa}')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded mt-1 hover:bg-blue-200">
                                        üìã Copy Nomor
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Pesan untuk dikirim:</span>
                                <button onclick="copyToClipboard(\`${pesan.replace(/`/g, '\\`')}\`)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">
                                    üìã Copy Pesan
                                </button>
                            </div>
                            <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded max-h-32 overflow-y-auto">
                                ${pesan.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        ${wali.wa ? `
                            <div class="mt-3 flex space-x-2">
                                <a href="https://wa.me/${wali.wa.replace(/\D/g, '').replace(/^0/, '62')}?text=${encodeURIComponent(pesan)}" 
                                   target="_blank" 
                                   class="flex-1 bg-green-600 text-white py-2 px-3 rounded text-center text-sm hover:bg-green-700 transition-colors">
                                    üì± Buka WhatsApp
                                </a>
                                <a href="https://web.whatsapp.com/send?phone=${wali.wa.replace(/\D/g, '').replace(/^0/, '62')}&text=${encodeURIComponent(pesan)}" 
                                   target="_blank" 
                                   class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-center text-sm hover:bg-blue-700 transition-colors">
                                    üíª WhatsApp Web
                                </a>
                            </div>
                        ` : `
                            <div class="mt-3 bg-yellow-50 border border-yellow-200 p-2 rounded">
                                <p class="text-xs text-yellow-800">‚ö†Ô∏è Nomor WhatsApp belum tersedia. Update di menu "Kelola Wali Kelas".</p>
                            </div>
                        `}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">üìã Kirim Manual ke WhatsApp</h3>
                            <p class="text-gray-600">Copy nomor dan pesan, lalu kirim manual via WhatsApp</p>
                        </div>
                        <button onclick="closeManualWAModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-blue-800 mb-2">üì± Cara Kirim Manual:</h4>
                        <ol class="text-sm text-blue-700 space-y-1">
                            <li>1. Klik "üìã Copy Nomor" untuk menyalin nomor WhatsApp</li>
                            <li>2. Klik "üìã Copy Pesan" untuk menyalin isi laporan</li>
                            <li>3. Buka WhatsApp di HP atau komputer</li>
                            <li>4. Cari kontak dengan nomor yang sudah dicopy</li>
                            <li>5. Paste dan kirim pesan laporan</li>
                            <li>6. Atau klik "üì± Buka WhatsApp" / "üíª WhatsApp Web" untuk otomatis</li>
                        </ol>
                    </div>
                    
                    <div class="space-y-4">
                        ${manualContent}
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeManualWAModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Selesai
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeManualWAModal() {
            const modal = document.getElementById('manualWAModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                // Use modern clipboard API
                navigator.clipboard.writeText(text).then(() => {
                    showCopyNotification('‚úÖ Berhasil dicopy!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyNotification('‚úÖ Berhasil dicopy!');
                } else {
                    showCopyNotification('‚ùå Gagal copy. Silakan copy manual.');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showCopyNotification('‚ùå Gagal copy. Silakan copy manual.');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopyNotification(message) {
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 2 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 2000);
        }

        function buatLaporan(jenis) {
            const today = new Date();
            let startDate, endDate, title;
            
            switch(jenis) {
                case 'harian':
                    startDate = endDate = today.toISOString().split('T')[0];
                    title = `Laporan Harian - ${today.toLocaleDateString('id-ID')}`;
                    break;
                case 'mingguan':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    title = `Laporan Mingguan - ${weekStart.toLocaleDateString('id-ID')} s/d ${today.toLocaleDateString('id-ID')}`;
                    break;
                case 'bulanan':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate = monthStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    title = `Laporan Bulanan - ${monthStart.toLocaleDateString('id-ID', {month: 'long', year: 'numeric'})}`;
                    break;
            }
            
            // Generate report data
            const reportData = generateReportData(startDate, endDate);
            
            // Display report
            const resultDiv = document.getElementById('laporanResult');
            const contentDiv = document.getElementById('laporanContent');
            
            contentDiv.innerHTML = `
                <h4 class="text-lg font-semibold mb-4">${title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h5 class="font-semibold">Total Jurnal</h5>
                        <p class="text-2xl font-bold text-blue-600">${reportData.totalJurnal}</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h5 class="font-semibold">Siswa Aktif</h5>
                        <p class="text-2xl font-bold text-green-600">${reportData.siswaAktif}</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h5 class="font-semibold">Rata-rata Harian</h5>
                        <p class="text-2xl font-bold text-purple-600">${reportData.rataRata}</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-2">Kelas</th>
                                <th class="border border-gray-300 px-4 py-2">Total Siswa</th>
                                <th class="border border-gray-300 px-4 py-2">Siswa Aktif</th>
                                <th class="border border-gray-300 px-4 py-2">Persentase</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.kelasData.map(kelas => `
                                <tr>
                                    <td class="border border-gray-300 px-4 py-2">${kelas.nama}</td>
                                    <td class="border border-gray-300 px-4 py-2">${kelas.total}</td>
                                    <td class="border border-gray-300 px-4 py-2">${kelas.aktif}</td>
                                    <td class="border border-gray-300 px-4 py-2">${kelas.persentase}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            resultDiv.classList.remove('hidden');
        }

        function generateReportData(startDate, endDate) {
            const kelasNames = ['7A', '7B', '7C', '7D', '7E', '7F', '8A', '8B', '8C', '8D', '8E', '8F', '9A', '9B', '9C', '9D', '9E', '9F'];
            let totalJurnal = 0;
            let totalSiswaAktif = 0;
            const kelasData = [];
            
            kelasNames.forEach(namaKelas => {
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === namaKelas);
                const totalSiswa = siswaKelas.length;
                
                let siswaAktifKelas = 0;
                siswaKelas.forEach(siswa => {
                    const userJurnals = jurnalData[siswa.nisn] || {};
                    const dates = Object.keys(userJurnals).filter(date => date >= startDate && date <= endDate);
                    if (dates.length > 0) {
                        siswaAktifKelas++;
                        totalJurnal += dates.length;
                    }
                });
                
                const persentase = totalSiswa > 0 ? Math.round((siswaAktifKelas / totalSiswa) * 100) : 0;
                
                kelasData.push({
                    nama: namaKelas,
                    total: totalSiswa,
                    aktif: siswaAktifKelas,
                    persentase: persentase
                });
                
                totalSiswaAktif += siswaAktifKelas;
            });
            
            const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            const rataRata = daysDiff > 0 ? Math.round(totalJurnal / daysDiff) : 0;
            
            return {
                totalJurnal: totalJurnal,
                siswaAktif: totalSiswaAktif,
                rataRata: rataRata,
                kelasData: kelasData
            };
        }

        function downloadLaporan() {
            try {
                const laporanContent = document.getElementById('laporanContent');
                if (!laporanContent || laporanContent.innerHTML.trim() === '') {
                    alert('‚ùå Tidak ada laporan untuk didownload!\n\nSilakan buat laporan terlebih dahulu dengan memilih jenis laporan (Harian/Mingguan/Bulanan).');
                    return;
                }
                
                // Show loading notification
                const loadingNotification = document.createElement('div');
                loadingNotification.id = 'downloadNotification';
                loadingNotification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loadingNotification.innerHTML = 'üì• Sedang memproses download...';
                document.body.appendChild(loadingNotification);
                
                // Get report title
                const titleElement = laporanContent.querySelector('h4');
                const reportTitle = titleElement ? titleElement.textContent : 'Laporan Jurnal Syukur';
                
                // Create comprehensive PDF content
                const today = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Extract statistics from the current report
                const statsCards = laporanContent.querySelectorAll('.bg-blue-100, .bg-green-100, .bg-purple-100');
                let totalJurnal = '0', siswaAktif = '0', rataRata = '0';
                
                if (statsCards.length >= 3) {
                    totalJurnal = statsCards[0].querySelector('.text-2xl')?.textContent || '0';
                    siswaAktif = statsCards[1].querySelector('.text-2xl')?.textContent || '0';
                    rataRata = statsCards[2].querySelector('.text-2xl')?.textContent || '0';
                }
                
                // Extract table data
                const table = laporanContent.querySelector('table');
                let tableHTML = '';
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    tableHTML = '<table border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    
                    rows.forEach((row, index) => {
                        const cells = row.querySelectorAll('th, td');
                        const isHeader = index === 0;
                        tableHTML += `<tr style="background-color: ${isHeader ? '#f3f4f6' : 'white'};">`;
                        
                        cells.forEach(cell => {
                            const tag = isHeader ? 'th' : 'td';
                            tableHTML += `<${tag} style="border: 1px solid #d1d5db; padding: 8px; text-align: ${isHeader ? 'center' : 'left'}; font-weight: ${isHeader ? 'bold' : 'normal'};">${cell.textContent}</${tag}>`;
                        });
                        
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</table>';
                }
                
                // Create complete HTML for PDF
                const pdfHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTitle}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            line-height: 1.6;
                            color: #333;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 3px solid #2563eb;
                            padding-bottom: 20px;
                        }
                        .school-name { 
                            font-size: 24px; 
                            font-weight: bold; 
                            color: #1e40af;
                            margin-bottom: 5px;
                        }
                        .school-address { 
                            font-size: 14px; 
                            color: #6b7280;
                            margin-bottom: 10px;
                        }
                        .report-title { 
                            font-size: 20px; 
                            font-weight: bold; 
                            color: #374151;
                            margin-top: 15px;
                        }
                        .report-date { 
                            font-size: 14px; 
                            color: #6b7280;
                            margin-top: 5px;
                        }
                        .stats-container { 
                            display: flex; 
                            justify-content: space-around; 
                            margin: 30px 0;
                            gap: 20px;
                        }
                        .stat-card { 
                            flex: 1;
                            text-align: center; 
                            padding: 20px; 
                            border-radius: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .stat-card.blue { background-color: #dbeafe; border-left: 4px solid #2563eb; }
                        .stat-card.green { background-color: #dcfce7; border-left: 4px solid #16a34a; }
                        .stat-card.purple { background-color: #f3e8ff; border-left: 4px solid #9333ea; }
                        .stat-title { 
                            font-size: 14px; 
                            color: #6b7280; 
                            margin-bottom: 8px;
                            font-weight: 600;
                        }
                        .stat-value { 
                            font-size: 32px; 
                            font-weight: bold; 
                            color: #1f2937;
                        }
                        .section-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: #374151;
                            margin: 30px 0 15px 0;
                            border-bottom: 2px solid #e5e7eb;
                            padding-bottom: 8px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        }
                        th { 
                            background-color: #f9fafb; 
                            font-weight: bold; 
                            color: #374151;
                        }
                        th, td { 
                            border: 1px solid #d1d5db; 
                            padding: 12px 8px; 
                            text-align: left;
                        }
                        tr:nth-child(even) { 
                            background-color: #f9fafb; 
                        }
                        .footer { 
                            margin-top: 40px; 
                            text-align: right;
                            border-top: 1px solid #e5e7eb;
                            padding-top: 20px;
                        }
                        .signature { 
                            margin-top: 60px;
                        }
                        .signature-line {
                            border-bottom: 1px solid #000;
                            width: 200px;
                            margin: 60px 0 5px 0;
                        }
                        @media print {
                            body { margin: 0; }
                            .stats-container { 
                                display: block; 
                            }
                            .stat-card { 
                                display: inline-block; 
                                width: 30%; 
                                margin: 10px 1%;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="school-name">SMP NEGERI 23 BALIKPAPAN</div>
                        <div class="school-address">
                            Jl. Soekarno Hatta KM. 8, Balikpapan Utara<br>
                            Kalimantan Timur - Indonesia
                        </div>
                        <div class="report-title">${reportTitle}</div>
                        <div class="report-date">Dicetak pada: ${today}</div>
                    </div>
                    
                    <div class="section-title">üìä Ringkasan Statistik</div>
                    <div class="stats-container">
                        <div class="stat-card blue">
                            <div class="stat-title">Total Jurnal</div>
                            <div class="stat-value">${totalJurnal}</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-title">Siswa Aktif</div>
                            <div class="stat-value">${siswaAktif}</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-title">Rata-rata Harian</div>
                            <div class="stat-value">${rataRata}</div>
                        </div>
                    </div>
                    
                    <div class="section-title">üìã Detail Per Kelas</div>
                    ${tableHTML}
                    
                    <div class="footer">
                        <div>Balikpapan, ${today}</div>
                        <div class="signature">
                            <div>Kepala Sekolah</div>
                            <div class="signature-line"></div>
                            <div><strong>${kepalaSekolahData.nama || 'Kepala Sekolah'}</strong></div>
                            <div>NIP. ${kepalaSekolahData.nip || '-'}</div>
                        </div>
                    </div>
                </body>
                </html>
                `;
                
                // Create blob and download
                const blob = new Blob([pdfHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Create filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${reportTitle.replace(/\s+/g, '_').toLowerCase()}_${timestamp}.html`;
                link.download = filename;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Update notification to success
                setTimeout(() => {
                    loadingNotification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    loadingNotification.innerHTML = '‚úÖ Download berhasil!';
                    
                    // Remove notification after 3 seconds
                    setTimeout(() => {
                        if (loadingNotification.parentNode) {
                            loadingNotification.parentNode.removeChild(loadingNotification);
                        }
                    }, 3000);
                }, 500);
                
                // Show detailed success message
                setTimeout(() => {
                    alert(`‚úÖ Laporan berhasil didownload!\n\nüìÑ File: ${filename}\n\nüìù Cara mencetak ke PDF:\n1. Buka file HTML yang didownload\n2. Tekan Ctrl+P (Windows) atau Cmd+P (Mac)\n3. Pilih "Save as PDF" atau "Microsoft Print to PDF"\n4. Klik "Save" untuk menyimpan sebagai PDF\n\nüí° File HTML dapat dibuka di browser apapun dan dicetak dengan kualitas tinggi.`);
                }, 1000);
                
            } catch (error) {
                console.error('Error downloading laporan:', error);
                
                // Update notification to error
                const notification = document.getElementById('downloadNotification');
                if (notification) {
                    notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    notification.innerHTML = '‚ùå Download gagal!';
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 3000);
                }
                
                alert('‚ùå Gagal mendownload laporan.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman dan buat laporan ulang\n3. Gunakan browser Chrome/Firefox terbaru\n4. Periksa ruang penyimpanan device');
            }
        }

        function lihatSiswaAktif(periode) {
            const today = new Date();
            let startDate;
            
            switch(periode) {
                case 'mingguan':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'bulanan':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'trimester':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 3);
                    break;
            }
            
            const siswaAktif = [];
            Object.values(siswaData).forEach(siswa => {
                const userJurnals = jurnalData[siswa.nisn] || {};
                const aktivitas = Object.keys(userJurnals).filter(date => {
                    return new Date(date) >= startDate;
                }).length;
                
                if (aktivitas > 0) {
                    siswaAktif.push({
                        ...siswa,
                        aktivitas: aktivitas
                    });
                }
            });
            
            // Sort by activity
            siswaAktif.sort((a, b) => b.aktivitas - a.aktivitas);
            
            // Display top 10
            const listDiv = document.getElementById('siswaAktifList');
            listDiv.innerHTML = siswaAktif.slice(0, 10).map((siswa, index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <h4 class="font-semibold">${siswa.nama}</h4>
                            <p class="text-sm text-gray-600">Kelas ${siswa.kelas} - ${siswa.aktivitas} jurnal</p>
                        </div>
                    </div>
                    <div class="text-yellow-500">
                        ${'‚≠ê'.repeat(Math.min(5, Math.ceil(siswa.aktivitas / 10)))}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('siswaAktifResult').classList.remove('hidden');
        }

        function kirimPiagam() {
            alert('Piagam penghargaan akan dikirim ke siswa terpilih!');
        }

        // Backup and Data Management
        function confirmDeleteData() {
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteDataModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-red-800 mb-2">‚ö†Ô∏è PERINGATAN PENTING!</h3>
                        <p class="text-gray-600 mb-4">Tindakan ini akan menghapus <strong>SEMUA DATA JURNAL SYUKUR</strong> dari sistem dan tidak dapat dibatalkan!</p>
                        
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-6">
                            <p class="text-sm text-red-800 mb-2"><strong>Data yang akan dihapus:</strong></p>
                            <ul class="text-sm text-red-700 text-left">
                                <li>‚Ä¢ Semua jurnal syukur siswa</li>
                                <li>‚Ä¢ Riwayat aktivitas harian</li>
                                <li>‚Ä¢ Statistik dan laporan</li>
                                <li>‚Ä¢ Data streak siswa</li>
                            </ul>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">Ketik <span class="font-mono bg-gray-100 px-2 py-1 rounded font-bold">HAPUS SEMUA</span> untuk konfirmasi:</p>
                        <input type="text" id="deleteConfirmation" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-center font-mono" placeholder="Ketik: HAPUS SEMUA">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="executeDeleteData()" class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            üóëÔ∏è Ya, Hapus Semua Data
                        </button>
                        <button onclick="closeDeleteDataModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function executeDeleteData() {
            const confirmation = document.getElementById('deleteConfirmation').value.trim();
            
            if (confirmation !== 'HAPUS SEMUA') {
                alert('‚ùå Konfirmasi tidak sesuai!\n\nKetik "HAPUS SEMUA" dengan benar untuk melanjutkan.');
                return;
            }
            
            try {
                // Count data before deletion
                const totalJurnal = Object.keys(jurnalData).reduce((total, nisn) => {
                    return total + Object.keys(jurnalData[nisn] || {}).length;
                }, 0);
                
                const totalSiswaAktif = Object.keys(jurnalData).length;
                
                // Clear all journal data
                jurnalData = {};
                
                // Reset student streaks
                Object.values(siswaData).forEach(siswa => {
                    siswa.streak = 0;
                    siswa.totalJurnal = 0;
                });
                
                // Save to storage
                saveDataToStorage();
                
                // Close modal
                closeDeleteDataModal();
                
                // Update dashboard
                loadKepalaData();
                
                // Show success message
                alert(`‚úÖ Berhasil menghapus semua data jurnal!\n\nüìä Data yang dihapus:\n‚Ä¢ ${totalJurnal} jurnal syukur\n‚Ä¢ ${totalSiswaAktif} siswa aktif\n‚Ä¢ Semua statistik dan riwayat\n\nüí° Sistem siap untuk data baru!`);
                
            } catch (error) {
                console.error('Error deleting data:', error);
                alert('‚ùå Terjadi kesalahan saat menghapus data. Silakan coba lagi.');
            }
        }

        function closeDeleteDataModal() {
            const modal = document.getElementById('deleteDataModal');
            if (modal) {
                modal.remove();
            }
        }

        function createBackup() {
            try {
                // Count data for summary
                const totalWali = waliKelasData.length;
                const totalSiswa = Object.keys(siswaData).length;
                const totalJurnal = Object.keys(jurnalData).reduce((total, nisn) => {
                    return total + Object.keys(jurnalData[nisn] || {}).length;
                }, 0);
                const totalKelas = kelasData.length;
                
                // Create comprehensive backup data
                const backupData = {
                    metadata: {
                        version: '1.0',
                        created: new Date().toISOString(),
                        createdBy: kepalaSekolahData.nama || 'Kepala Sekolah',
                        school: 'SMP Negeri 23 Balikpapan',
                        description: 'Backup lengkap data Jurnal Syukur',
                        summary: {
                            totalWaliKelas: totalWali,
                            totalSiswa: totalSiswa,
                            totalJurnal: totalJurnal,
                            totalKelas: totalKelas
                        }
                    },
                    data: {
                        kepalaSekolah: kepalaSekolahData,
                        waliKelas: waliKelasData,
                        siswa: siswaData,
                        jurnal: jurnalData,
                        kelas: kelasData
                    }
                };
                
                // Convert to JSON string with formatting
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `backup_jurnal_syukur_${timestamp}.json`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up URL object
                URL.revokeObjectURL(link.href);
                
                // Show success message with summary
                alert(`‚úÖ Backup data berhasil dibuat!\n\nüì¶ File: backup_jurnal_syukur_${timestamp}.json\n\nüìä Ringkasan data:\n‚Ä¢ ${totalWali} Wali Kelas\n‚Ä¢ ${totalSiswa} Siswa\n‚Ä¢ ${totalJurnal} Jurnal Syukur\n‚Ä¢ ${totalKelas} Kelas\n\nüíæ File tersimpan di folder Downloads Anda.`);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('‚ùå Gagal membuat backup data.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman\n3. Gunakan browser Chrome/Firefox terbaru\n4. Periksa ruang penyimpanan device');
            }
        }

        function confirmDeleteSiswaData() {
            // Create confirmation modal for wali kelas
            const modal = document.createElement('div');
            modal.id = 'deleteSiswaDataModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            
            const thisMonth = new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const kelasCurrentUser = currentUser.kelas;
            const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelasCurrentUser);
            
            // Count journals to be deleted
            let totalJurnalBulanIni = 0;
            const thisMonthPrefix = new Date().toISOString().substring(0, 7);
            siswaKelas.forEach(siswa => {
                if (jurnalData[siswa.nisn]) {
                    const jurnalBulanIni = Object.keys(jurnalData[siswa.nisn]).filter(date => date.startsWith(thisMonthPrefix));
                    totalJurnalBulanIni += jurnalBulanIni.length;
                }
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-orange-800 mb-2">üóëÔ∏è Hapus Data Jurnal Bulan Ini</h3>
                        <p class="text-gray-600 mb-4">Hapus semua data jurnal siswa kelas <strong>${kelasCurrentUser}</strong> untuk bulan <strong>${thisMonth}</strong>?</p>
                        
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg mb-6">
                            <p class="text-sm text-orange-800 mb-2"><strong>Data yang akan dihapus:</strong></p>
                            <ul class="text-sm text-orange-700 text-left">
                                <li>‚Ä¢ ${totalJurnalBulanIni} jurnal syukur bulan ini</li>
                                <li>‚Ä¢ ${siswaKelas.length} siswa di kelas ${kelasCurrentUser}</li>
                                <li>‚Ä¢ Statistik bulan ${thisMonth}</li>
                            </ul>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">Tindakan ini tidak dapat dibatalkan!</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="executeSiswaDataDelete()" class="flex-1 bg-orange-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-700 transition-colors">
                            üóëÔ∏è Ya, Hapus Data Bulan Ini
                        </button>
                        <button onclick="closeSiswaDataDeleteModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function executeSiswaDataDelete() {
            try {
                const thisMonthPrefix = new Date().toISOString().substring(0, 7);
                const kelasCurrentUser = currentUser.kelas;
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelasCurrentUser);
                
                let deletedCount = 0;
                
                siswaKelas.forEach(siswa => {
                    if (jurnalData[siswa.nisn]) {
                        Object.keys(jurnalData[siswa.nisn]).forEach(date => {
                            if (date.startsWith(thisMonthPrefix)) {
                                delete jurnalData[siswa.nisn][date];
                                deletedCount++;
                            }
                        });
                        
                        // Reset streak if no journals left
                        if (Object.keys(jurnalData[siswa.nisn]).length === 0) {
                            siswa.streak = 0;
                        }
                    }
                });
                
                saveDataToStorage();
                closeSiswaDataDeleteModal();
                
                // Update monitoring and stats
                loadWaliData();
                updateSiswaMonitoring();
                
                const thisMonth = new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                alert(`‚úÖ Berhasil menghapus data jurnal bulan ini!\n\nüìä Ringkasan:\n‚Ä¢ ${deletedCount} jurnal dihapus\n‚Ä¢ Kelas: ${kelasCurrentUser}\n‚Ä¢ Periode: ${thisMonth}\n\nüí° Data bulan lain tetap aman.`);
                
            } catch (error) {
                console.error('Error deleting siswa data:', error);
                alert('‚ùå Terjadi kesalahan saat menghapus data. Silakan coba lagi.');
            }
        }

        function closeSiswaDataDeleteModal() {
            const modal = document.getElementById('deleteSiswaDataModal');
            if (modal) {
                modal.remove();
            }
        }

        function createSiswaBackup() {
            try {
                const kelasCurrentUser = currentUser.kelas;
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelasCurrentUser);
                
                // Count journals for this class
                let totalJurnalKelas = 0;
                const jurnalKelas = {};
                
                siswaKelas.forEach(siswa => {
                    if (jurnalData[siswa.nisn]) {
                        jurnalKelas[siswa.nisn] = jurnalData[siswa.nisn];
                        totalJurnalKelas += Object.keys(jurnalData[siswa.nisn]).length;
                    }
                });
                
                // Create comprehensive backup data
                const backupData = {
                    metadata: {
                        version: '1.0',
                        created: new Date().toISOString(),
                        createdBy: currentUser.nama,
                        kelas: kelasCurrentUser,
                        school: 'SMP Negeri 23 Balikpapan',
                        description: `Backup data kelas ${kelasCurrentUser}`,
                        summary: {
                            totalSiswa: siswaKelas.length,
                            totalJurnal: totalJurnalKelas,
                            periode: 'Semua data'
                        }
                    },
                    data: {
                        waliKelas: {
                            nip: currentUser.nip,
                            nama: currentUser.nama,
                            kelas: currentUser.kelas,
                            wa: currentUser.wa
                        },
                        siswa: siswaKelas,
                        jurnal: jurnalKelas
                    }
                };
                
                // Convert to JSON string with formatting
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `backup_kelas_${kelasCurrentUser}_${timestamp}.json`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up URL object
                URL.revokeObjectURL(link.href);
                
                // Show success message with summary
                alert(`‚úÖ Backup data kelas berhasil dibuat!\n\nüì¶ File: backup_kelas_${kelasCurrentUser}_${timestamp}.json\n\nüìä Ringkasan data:\n‚Ä¢ Kelas: ${kelasCurrentUser}\n‚Ä¢ ${siswaKelas.length} Siswa\n‚Ä¢ ${totalJurnalKelas} Jurnal Syukur\n‚Ä¢ Wali Kelas: ${currentUser.nama}\n\nüíæ File tersimpan di folder Downloads Anda.`);
                
            } catch (error) {
                console.error('Error creating siswa backup:', error);
                alert('‚ùå Gagal membuat backup data kelas.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman\n3. Gunakan browser Chrome/Firefox terbaru\n4. Periksa ruang penyimpanan device');
            }
        }

        // Monitoring for Wali Kelas
        function updateSiswaMonitoring() {
            const grid = document.getElementById('siswaMonitoringGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const kelasCurrentUser = currentUser.kelas;
            const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelasCurrentUser);
            
            if (siswaKelas.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full bg-gray-50 p-8 rounded-lg text-center">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Siswa</h3>
                        <p class="text-gray-500 mb-4">Kelas ${kelasCurrentUser} belum memiliki siswa terdaftar.</p>
                        <button onclick="showWaliSection('siswaSection')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            + Tambah Siswa
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort students by name alphabetically
            siswaKelas.sort((a, b) => a.nama.localeCompare(b.nama, 'id-ID'));
            
            siswaKelas.forEach(siswa => {
                const userJurnals = jurnalData[siswa.nisn] || {};
                const totalJurnal = Object.keys(userJurnals).length;
                const today = new Date().toISOString().split('T')[0];
                const aktifHariIni = userJurnals[today] ? 'Ya' : 'Tidak';
                
                // Calculate this week's activity
                const thisWeek = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    thisWeek.push({
                        date: dateStr,
                        day: date.toLocaleDateString('id-ID', { weekday: 'short' }),
                        active: userJurnals[dateStr] ? true : false
                    });
                }
                
                // Calculate streak
                let currentStreak = 0;
                const sortedDates = Object.keys(userJurnals).sort().reverse();
                const todayDate = new Date().toISOString().split('T')[0];
                
                if (sortedDates.length > 0 && sortedDates[0] === todayDate) {
                    currentStreak = 1;
                    for (let i = 1; i < sortedDates.length; i++) {
                        const currentDate = new Date(sortedDates[i-1]);
                        const prevDate = new Date(sortedDates[i]);
                        const diffTime = currentDate - prevDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                }
                
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-800 mb-1">${siswa.nama}</h3>
                            <p class="text-sm text-gray-500">NISN: ${siswa.nisn}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${aktifHariIni === 'Ya' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${aktifHariIni === 'Ya' ? '‚úÖ Aktif Hari Ini' : '‚è∞ Belum Aktif'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${totalJurnal}</div>
                            <div class="text-sm text-blue-700">Total Jurnal</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600">${currentStreak}</div>
                            <div class="text-sm text-orange-700">Hari Berturut</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-sm font-medium text-gray-700 mb-2">Aktivitas 7 Hari Terakhir:</div>
                        <div class="flex space-x-1">
                            ${thisWeek.map(day => `
                                <div class="flex-1 text-center">
                                    <div class="text-xs text-gray-500 mb-1">${day.day}</div>
                                    <div class="w-full h-6 rounded ${day.active ? 'bg-green-400' : 'bg-gray-200'}" title="${day.date}"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${totalJurnal > 0 ? `
                        <button onclick="lihatDetailJurnal('${siswa.nisn}', '${siswa.nama}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            üìñ Lihat Detail Jurnal
                        </button>
                    ` : `
                        <div class="w-full bg-gray-100 text-gray-500 py-2 px-4 rounded-lg text-center text-sm">
                            Belum ada jurnal
                        </div>
                    `}
                `;
                grid.appendChild(card);
            });
            
            // Update WhatsApp select options
            const select = document.getElementById('pilihSiswaWA');
            if (select) {
                select.innerHTML = '<option value="">Pilih Siswa</option><option value="all">Semua Siswa</option>';
                siswaKelas.forEach(siswa => {
                    select.innerHTML += `<option value="${siswa.nisn}">${siswa.nama}</option>`;
                });
            }
        }

        function lihatDetailJurnal(nisn, nama) {
            const userJurnals = jurnalData[nisn] || {};
            const sortedDates = Object.keys(userJurnals).sort().reverse();
            
            if (sortedDates.length === 0) {
                alert(`${nama} belum memiliki jurnal syukur.`);
                return;
            }
            
            // Create modal to show journal details
            const modal = document.createElement('div');
            modal.id = 'detailJurnalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">üìñ Detail Jurnal Syukur</h3>
                            <p class="text-gray-600">${nama} (NISN: ${nisn})</p>
                        </div>
                        <button onclick="closeDetailJurnalModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600">${sortedDates.length}</div>
                                <div class="text-sm text-blue-700">Total Jurnal</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600">${sortedDates.filter(date => {
                                    const jurnalDate = new Date(date);
                                    const thisMonth = new Date();
                                    return jurnalDate.getMonth() === thisMonth.getMonth() && jurnalDate.getFullYear() === thisMonth.getFullYear();
                                }).length}</div>
                                <div class="text-sm text-green-700">Bulan Ini</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-600">${sortedDates.filter(date => {
                                    const jurnalDate = new Date(date);
                                    const thisWeek = new Date();
                                    const weekStart = new Date(thisWeek.setDate(thisWeek.getDate() - thisWeek.getDay()));
                                    return jurnalDate >= weekStart;
                                }).length}</div>
                                <div class="text-sm text-purple-700">Minggu Ini</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        ${sortedDates.slice(0, 20).map(date => {
                            const jurnal = userJurnals[date];
                            const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                            
                            return `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold text-gray-800">${formattedDate}</h4>
                                        <span class="text-xs text-gray-500">${new Date(jurnal.timestamp).toLocaleTimeString('id-ID')}</span>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="bg-white p-3 rounded border-l-4 border-blue-400">
                                            <div class="text-sm font-medium text-blue-800 mb-1">1. Hal pertama yang disyukuri:</div>
                                            <div class="text-gray-700">${jurnal.syukur1}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded border-l-4 border-green-400">
                                            <div class="text-sm font-medium text-green-800 mb-1">2. Hal kedua yang disyukuri:</div>
                                            <div class="text-gray-700">${jurnal.syukur2}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded border-l-4 border-purple-400">
                                            <div class="text-sm font-medium text-purple-800 mb-1">3. Hal ketiga yang disyukuri:</div>
                                            <div class="text-gray-700">${jurnal.syukur3}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${sortedDates.length > 20 ? `
                            <div class="text-center py-4">
                                <p class="text-gray-500">Menampilkan 20 jurnal terbaru dari ${sortedDates.length} total jurnal</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeDetailJurnalModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeDetailJurnalModal() {
            const modal = document.getElementById('detailJurnalModal');
            if (modal) {
                modal.remove();
            }
        }

        function kirimPesanSiswaWA() {
            const pilihan = document.getElementById('pilihSiswaWA').value;
            if (!pilihan) {
                alert('Pilih siswa terlebih dahulu!');
                return;
            }
            
            let targetSiswa = [];
            if (pilihan === 'all') {
                const kelasCurrentUser = currentUser.kelas;
                targetSiswa = Object.values(siswaData).filter(s => s.kelas === kelasCurrentUser);
            } else {
                const siswa = siswaData[pilihan];
                if (siswa) {
                    targetSiswa = [siswa];
                }
            }
            
            if (targetSiswa.length === 0) {
                alert('Tidak ada siswa ditemukan!');
                return;
            }
            
            let pesanTerkirim = 0;
            let siswaTanpaWA = [];
            
            targetSiswa.forEach(siswa => {
                const userJurnals = jurnalData[siswa.nisn] || {};
                const totalJurnal = Object.keys(userJurnals).length;
                const today = new Date().toISOString().split('T')[0];
                const sudahIsiHariIni = userJurnals[today] ? 'sudah' : 'belum';
                const tanggal = new Date().toLocaleDateString('id-ID');
                
                const pesan = `üìù *PENGINGAT JURNAL SYUKUR*
üìÖ Tanggal: ${tanggal}
üë®‚Äçüéì Nama: ${siswa.nama}
üéì Kelas: ${currentUser.kelas}

üìä *Status Anda:*
${sudahIsiHariIni === 'sudah' ? '‚úÖ Sudah mengisi jurnal hari ini' : '‚è∞ Belum mengisi jurnal hari ini'}
üìà Total jurnal: ${totalJurnal}

${sudahIsiHariIni === 'sudah' ? 
'üéâ Alhamdulillah! Terima kasih sudah konsisten menulis jurnal syukur. Semoga berkah selalu menyertai!' : 
'üí™ Ayo semangat! Jangan lupa tulis 3 hal yang kamu syukuri hari ini. Setiap rasa syukur adalah berkah!'}

Tetap semangat berbagi kebaikan! üåü

_${currentUser.nama}_
_Wali Kelas ${currentUser.kelas}_
_SMP Negeri 23 Balikpapan_`;
                
                // Check if siswa has WhatsApp number
                if (!siswa.wa || siswa.wa.trim() === '') {
                    siswaTanpaWA.push(siswa.nama);
                    return;
                }
                
                // Clean phone number
                let cleanWA = siswa.wa.toString().replace(/\D/g, ''); // Remove non-digits
                
                if (!cleanWA || cleanWA.length < 10) {
                    siswaTanpaWA.push(`${siswa.nama} - nomor tidak valid`);
                    return;
                }
                
                // Format Indonesian phone number
                if (cleanWA.startsWith('0')) {
                    cleanWA = '62' + cleanWA.substring(1);
                } else if (!cleanWA.startsWith('62')) {
                    cleanWA = '62' + cleanWA;
                }
                
                // Create WhatsApp URL with better encoding and fallback options
                const encodedPesan = encodeURIComponent(pesan);
                
                // Try multiple WhatsApp URL formats with better compatibility
                const waURLs = [
                    `https://wa.me/${cleanWA}?text=${encodedPesan}`,
                    `https://web.whatsapp.com/send?phone=${cleanWA}&text=${encodedPesan}`,
                    `whatsapp://send?phone=${cleanWA}&text=${encodedPesan}`,
                    `https://api.whatsapp.com/send/?phone=${cleanWA}&text=${encodedPesan}&type=phone_number&app_absent=0`
                ];
                
                // Add small delay between messages
                setTimeout(() => {
                    let success = false;
                    let lastError = '';
                    
                    // Function to try opening WhatsApp with better error detection
                    const tryOpenWhatsApp = (url, formatName) => {
                        return new Promise((resolve) => {
                            try {
                                // Create a temporary link element for better compatibility
                                const link = document.createElement('a');
                                link.href = url;
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                                
                                // Add to DOM temporarily
                                document.body.appendChild(link);
                                
                                // Try to click the link
                                link.click();
                                
                                // Remove from DOM
                                document.body.removeChild(link);
                                
                                // Check if it worked by trying window.open as fallback
                                setTimeout(() => {
                                    try {
                                        const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                                        if (newWindow) {
                                            // Close the window after a short delay to avoid popup blocking
                                            setTimeout(() => {
                                                if (!newWindow.closed) {
                                                    // Window is still open, likely successful
                                                    resolve(true);
                                                } else {
                                                    resolve(false);
                                                }
                                            }, 1000);
                                        } else {
                                            resolve(false);
                                        }
                                    } catch (popupError) {
                                        console.warn(`Popup blocked for ${formatName}:`, popupError);
                                        resolve(false);
                                    }
                                }, 500);
                                
                            } catch (error) {
                                console.error(`Error with ${formatName}:`, error);
                                lastError = error.message;
                                resolve(false);
                            }
                        });
                    };
                    
                    // Try each URL format sequentially
                    const tryFormats = async () => {
                        for (let urlIndex = 0; urlIndex < waURLs.length && !success; urlIndex++) {
                            const formatNames = ['wa.me', 'web.whatsapp.com', 'whatsapp://', 'api.whatsapp.com'];
                            const formatName = formatNames[urlIndex];
                            
                            console.log(`Trying ${formatName} for ${siswa.nama}...`);
                            const result = await tryOpenWhatsApp(waURLs[urlIndex], formatName);
                            
                            if (result) {
                                success = true;
                                console.log(`‚úÖ WhatsApp opened successfully for ${siswa.nama} using ${formatName}`);
                                break;
                            } else {
                                console.warn(`‚ùå ${formatName} failed for ${siswa.nama}`);
                                // Small delay between attempts
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                        
                        if (!success) {
                            siswaTanpaWA.push(`${siswa.nama} - semua format diblokir/gagal${lastError ? ` (${lastError})` : ''}`);
                        }
                    };
                    
                    tryFormats();
                }, pesanTerkirim * 2000); // 2 second delay between messages
                
                pesanTerkirim++;
            });
            
            // Show result message with blocking solutions
            let resultMessage = '';
            if (pesanTerkirim > 0) {
                resultMessage += `‚úÖ Berhasil membuka ${pesanTerkirim} chat WhatsApp untuk mengirim pengingat!\n\n`;
                resultMessage += `üì± *Petunjuk:*\n‚Ä¢ Setiap chat akan terbuka secara otomatis\n‚Ä¢ Tunggu beberapa detik antar chat\n‚Ä¢ Tekan "Send" di setiap chat WhatsApp\n\n`;
            }
            
            if (siswaTanpaWA.length > 0) {
                resultMessage += `‚ö†Ô∏è Siswa dengan masalah WhatsApp:\n`;
                resultMessage += siswaTanpaWA.join('\n');
                resultMessage += '\n\nüí° *Solusi:*\n‚Ä¢ Update nomor WhatsApp di menu "Kelola Siswa"\n‚Ä¢ Pastikan format nomor: 08xxxxxxxxxx atau 62xxxxxxxxx\n‚Ä¢ Aktifkan popup di browser untuk WhatsApp';
                
                // Check if there are blocking issues
                const hasBlockingIssues = siswaTanpaWA.some(msg => msg.includes('diblokir'));
                if (hasBlockingIssues) {
                    resultMessage += '\n\nüö´ *Khusus untuk masalah "diblokir":*\n‚Ä¢ Sistem sudah mencoba 3 format URL berbeda\n‚Ä¢ Coba gunakan browser Chrome atau Firefox terbaru\n‚Ä¢ Nonaktifkan ad blocker atau extension yang memblokir\n‚Ä¢ Pastikan koneksi internet stabil\n‚Ä¢ Coba akses dari jaringan internet yang berbeda\n‚Ä¢ Gunakan mode incognito/private browsing';
                }
            }
            
            if (resultMessage) {
                alert(resultMessage);
            } else {
                alert('‚ùå Tidak ada siswa yang dapat dihubungi!\n\nPastikan ada siswa dengan nomor WhatsApp yang valid.');
            }
        }

        // Class Management Functions
        function populateKelasTable() {
            const tbody = document.getElementById('kelasTableBody');
            tbody.innerHTML = '';
            
            kelasData.forEach((kelas, index) => {
                const waliKelas = waliKelasData.find(w => w.kelas === kelas.nama);
                const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelas.nama);
                const jumlahSiswa = siswaKelas.length;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${kelas.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${waliKelas ? waliKelas.nama : '-'}</td>
                    <td class="border border-gray-300 px-4 py-2">${jumlahSiswa}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="px-2 py-1 rounded text-xs ${kelas.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${kelas.status}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="editKelas(${index})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">Edit</button>
                        <button onclick="toggleKelasStatus(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-1">${kelas.status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan'}</button>
                        <button onclick="deleteKelas(${index})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Hapus</button>
                    </td>
                `;
            });
        }

        function showAddKelasForm() {
            document.getElementById('addKelasForm').classList.remove('hidden');
        }

        function hideAddKelasForm() {
            document.getElementById('addKelasForm').classList.add('hidden');
            document.getElementById('addKelasForm').querySelector('form').reset();
        }

        function addKelas(event) {
            event.preventDefault();
            
            const namaKelas = document.getElementById('newKelasNama').value.trim();
            const tingkat = document.getElementById('newKelasTingkat').value;
            
            // Check if class already exists
            if (kelasData.find(k => k.nama === namaKelas)) {
                alert('Kelas dengan nama tersebut sudah ada!');
                return;
            }
            
            const newKelas = {
                nama: namaKelas,
                tingkat: tingkat,
                status: 'Aktif'
            };
            
            kelasData.push(newKelas);
            populateKelasTable();
            hideAddKelasForm();
            saveDataToStorage();
            alert('Kelas berhasil ditambahkan!');
        }

        function editKelas(index) {
            const kelas = kelasData[index];
            if (!kelas) {
                alert('Data kelas tidak ditemukan!');
                return;
            }
            
            const newNama = prompt('Masukkan Nama Kelas:', kelas.nama);
            if (newNama !== null && newNama.trim() !== '') {
                const newTingkat = prompt('Masukkan Tingkat (7/8/9):', kelas.tingkat);
                if (newTingkat !== null && ['7', '8', '9'].includes(newTingkat.trim())) {
                    // Check if new name already exists (except current)
                    const existingKelas = kelasData.find((k, i) => k.nama === newNama.trim() && i !== index);
                    if (existingKelas) {
                        alert('Kelas dengan nama tersebut sudah ada!');
                        return;
                    }
                    
                    const oldNama = kelas.nama;
                    kelas.nama = newNama.trim();
                    kelas.tingkat = newTingkat.trim();
                    
                    // Update wali kelas data
                    const wali = waliKelasData.find(w => w.kelas === oldNama);
                    if (wali) {
                        wali.kelas = kelas.nama;
                    }
                    
                    // Update siswa data
                    Object.values(siswaData).forEach(siswa => {
                        if (siswa.kelas === oldNama) {
                            siswa.kelas = kelas.nama;
                        }
                    });
                    
                    populateKelasTable();
                    saveDataToStorage();
                    alert('Data kelas berhasil diupdate!');
                } else if (newTingkat !== null) {
                    alert('Tingkat harus 7, 8, atau 9!');
                }
            }
        }

        function toggleKelasStatus(index) {
            const kelas = kelasData[index];
            if (!kelas) {
                alert('Data kelas tidak ditemukan!');
                return;
            }
            
            const newStatus = kelas.status === 'Aktif' ? 'Nonaktif' : 'Aktif';
            if (confirm(`${newStatus === 'Aktif' ? 'Aktifkan' : 'Nonaktifkan'} kelas ${kelas.nama}?`)) {
                kelas.status = newStatus;
                populateKelasTable();
                saveDataToStorage();
                alert(`Kelas ${kelas.nama} berhasil ${newStatus === 'Aktif' ? 'diaktifkan' : 'dinonaktifkan'}!`);
            }
        }

        function deleteKelas(index) {
            const kelas = kelasData[index];
            if (!kelas) {
                alert('Data kelas tidak ditemukan!');
                return;
            }
            
            const siswaKelas = Object.values(siswaData).filter(s => s.kelas === kelas.nama);
            const waliKelas = waliKelasData.find(w => w.kelas === kelas.nama);
            
            let confirmMessage = `Yakin ingin menghapus kelas ${kelas.nama}?`;
            if (siswaKelas.length > 0) {
                confirmMessage += `\n\nPerhatian: Ada ${siswaKelas.length} siswa di kelas ini yang akan kehilangan kelas!`;
            }
            if (waliKelas) {
                confirmMessage += `\n\nWali kelas ${waliKelas.nama} akan kehilangan kelas!`;
            }
            
            if (confirm(confirmMessage)) {
                // Remove class
                kelasData.splice(index, 1);
                
                // Update wali kelas
                if (waliKelas) {
                    waliKelas.kelas = '';
                }
                
                // Update siswa
                siswaKelas.forEach(siswa => {
                    siswa.kelas = '';
                });
                
                populateKelasTable();
                saveDataToStorage();
                alert('Kelas berhasil dihapus!');
            }
        }

        // Class Template Functions
        function downloadKelasTemplate() {
            try {
                // Create comprehensive class template data
                const template = [
                    ['Nama Kelas', 'Tingkat', 'Status'],
                    ['7A', '7', 'Aktif'],
                    ['7B', '7', 'Aktif'],
                    ['7C', '7', 'Aktif'],
                    ['7D', '7', 'Aktif'],
                    ['7E', '7', 'Aktif'],
                    ['7F', '7', 'Aktif'],
                    ['8A', '8', 'Aktif'],
                    ['8B', '8', 'Aktif'],
                    ['8C', '8', 'Aktif'],
                    ['8D', '8', 'Aktif'],
                    ['8E', '8', 'Aktif'],
                    ['8F', '8', 'Aktif'],
                    ['9A', '9', 'Aktif'],
                    ['9B', '9', 'Aktif'],
                    ['9C', '9', 'Aktif'],
                    ['9D', '9', 'Aktif'],
                    ['9E', '9', 'Aktif'],
                    ['9F', '9', 'Aktif']
                ];
                
                // Create workbook and worksheet
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template Kelas');
                
                // Set column widths for better readability
                ws['!cols'] = [
                    {wch: 15}, // Nama Kelas
                    {wch: 12}, // Tingkat
                    {wch: 12}  // Status
                ];
                
                // Generate and download file
                const fileName = `template_kelas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ Template Kelas berhasil didownload!\n\nüìã Format Template:\n‚Ä¢ Nama Kelas: 7A, 7B, 8A, 8B, 9A, 9B, dst\n‚Ä¢ Tingkat: Angka 7, 8, atau 9\n‚Ä¢ Status: Aktif atau Nonaktif\n\nüìù Contoh: 18 kelas lengkap dari 7A-7F, 8A-8F, 9A-9F');
            } catch (error) {
                console.error('Error downloading kelas template:', error);
                alert('‚ùå Gagal mendownload template.\n\nSolusi:\n1. Pastikan browser mendukung download\n2. Coba refresh halaman\n3. Gunakan browser Chrome/Firefox terbaru');
            }
        }

        function importKelasFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    // Skip header row
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1]) {
                            const namaKelas = row[0].toString().trim();
                            const tingkat = row[1].toString().trim();
                            const status = row[2] ? row[2].toString().trim() : 'Aktif';
                            
                            // Validate tingkat
                            if (!['7', '8', '9'].includes(tingkat)) {
                                console.warn(`Tingkat tidak valid untuk kelas ${namaKelas}: ${tingkat}`);
                                skippedCount++;
                                continue;
                            }
                            
                            // Validate status
                            const validStatus = ['Aktif', 'Nonaktif'].includes(status) ? status : 'Aktif';
                            
                            // Check if class already exists
                            const existingIndex = kelasData.findIndex(k => k.nama === namaKelas);
                            if (existingIndex >= 0) {
                                // Update existing class
                                kelasData[existingIndex] = {
                                    nama: namaKelas,
                                    tingkat: tingkat,
                                    status: validStatus
                                };
                            } else {
                                // Add new class
                                kelasData.push({
                                    nama: namaKelas,
                                    tingkat: tingkat,
                                    status: validStatus
                                });
                            }
                            importedCount++;
                        } else {
                            skippedCount++;
                        }
                    }
                    
                    populateKelasTable();
                    saveDataToStorage();
                    
                    let message = `Import selesai!\n‚úÖ Berhasil: ${importedCount} kelas`;
                    if (skippedCount > 0) {
                        message += `\n‚ö†Ô∏è Dilewati: ${skippedCount} baris (data tidak lengkap/tidak valid)`;
                    }
                    alert(message);
                    
                } catch (error) {
                    console.error('Error importing kelas:', error);
                    alert('Gagal mengimport data kelas. Pastikan format file Excel sesuai template.');
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset input
            event.target.value = '';
        }

        // Delete All Students Function
        function confirmDeleteAllSiswa() {
            // Count total students and journals
            const totalSiswa = Object.keys(siswaData).length;
            const totalJurnal = Object.keys(jurnalData).reduce((total, nisn) => {
                return total + Object.keys(jurnalData[nisn] || {}).length;
            }, 0);
            
            if (totalSiswa === 0) {
                alert('‚ùå Tidak ada data siswa untuk dihapus!\n\nSistem sudah kosong dari data siswa.');
                return;
            }
            
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteAllSiswaModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-red-800 mb-2">‚ö†Ô∏è PERINGATAN SANGAT PENTING!</h3>
                        <p class="text-gray-600 mb-4">Tindakan ini akan menghapus <strong>SEMUA DATA SISWA</strong> dari seluruh sistem dan tidak dapat dibatalkan!</p>
                        
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-6">
                            <p class="text-sm text-red-800 mb-2"><strong>üìä Data yang akan dihapus:</strong></p>
                            <ul class="text-sm text-red-700 text-left">
                                <li>‚Ä¢ ${totalSiswa} siswa dari semua kelas</li>
                                <li>‚Ä¢ ${totalJurnal} jurnal syukur</li>
                                <li>‚Ä¢ Semua riwayat aktivitas siswa</li>
                                <li>‚Ä¢ Data streak dan statistik siswa</li>
                                <li>‚Ä¢ Semua data login siswa</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                            <p class="text-sm text-yellow-800">
                                <strong>üí° Saran:</strong> Buat backup data terlebih dahulu di menu "Backup Data" sebelum melanjutkan!
                            </p>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">Ketik <span class="font-mono bg-gray-100 px-2 py-1 rounded font-bold">HAPUS SEMUA SISWA</span> untuk konfirmasi:</p>
                        <input type="text" id="deleteAllSiswaConfirmation" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-center font-mono" placeholder="Ketik: HAPUS SEMUA SISWA">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="executeDeleteAllSiswa()" class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            üóëÔ∏è Ya, Hapus Semua Siswa
                        </button>
                        <button onclick="closeDeleteAllSiswaModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            ‚ùå Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function executeDeleteAllSiswa() {
            const confirmation = document.getElementById('deleteAllSiswaConfirmation').value.trim();
            
            if (confirmation !== 'HAPUS SEMUA SISWA') {
                alert('‚ùå Konfirmasi tidak sesuai!\n\nKetik "HAPUS SEMUA SISWA" dengan benar untuk melanjutkan.');
                return;
            }
            
            try {
                // Count data before deletion for summary
                const totalSiswa = Object.keys(siswaData).length;
                const totalJurnal = Object.keys(jurnalData).reduce((total, nisn) => {
                    return total + Object.keys(jurnalData[nisn] || {}).length;
                }, 0);
                
                // Count students per class for detailed summary
                const siswaPerKelas = {};
                Object.values(siswaData).forEach(siswa => {
                    if (siswa.kelas) {
                        siswaPerKelas[siswa.kelas] = (siswaPerKelas[siswa.kelas] || 0) + 1;
                    }
                });
                
                // Clear all student data
                siswaData = {};
                
                // Clear all journal data
                jurnalData = {};
                
                // Save to storage
                saveDataToStorage();
                
                // Close modal
                closeDeleteAllSiswaModal();
                
                // Update all relevant displays
                if (currentRole === 'kepala') {
                    loadKepalaData();
                    updateMonitoringKelas();
                    populateKelasTable();
                } else if (currentRole === 'wali') {
                    populateSiswaTable();
                    loadWaliData();
                    updateSiswaMonitoring();
                }
                
                // Create detailed summary message
                let summaryMessage = `‚úÖ Berhasil menghapus semua data siswa!\n\nüìä Ringkasan penghapusan:\n‚Ä¢ ${totalSiswa} siswa dihapus\n‚Ä¢ ${totalJurnal} jurnal syukur dihapus\n‚Ä¢ Semua riwayat aktivitas dihapus\n\n`;
                
                if (Object.keys(siswaPerKelas).length > 0) {
                    summaryMessage += `üìã Detail per kelas:\n`;
                    Object.entries(siswaPerKelas).forEach(([kelas, jumlah]) => {
                        summaryMessage += `‚Ä¢ Kelas ${kelas}: ${jumlah} siswa\n`;
                    });
                    summaryMessage += `\n`;
                }
                
                summaryMessage += `üí° Sistem siap untuk data siswa baru!\n\n‚ö†Ô∏è Catatan: Data wali kelas dan kelas tetap aman.`;
                
                alert(summaryMessage);
                
            } catch (error) {
                console.error('Error deleting all siswa:', error);
                alert('‚ùå Terjadi kesalahan saat menghapus data siswa. Silakan coba lagi.');
            }
        }

        function closeDeleteAllSiswaModal() {
            const modal = document.getElementById('deleteAllSiswaModal');
            if (modal) {
                modal.remove();
            }
        }

        // Function to update all monitoring displays immediately
        function updateAllMonitoringDisplays() {
            // Update kepala sekolah monitoring if visible
            if (currentRole === 'kepala' && !document.getElementById('kepalaDashboard').classList.contains('hidden')) {
                updateMonitoringKelas();
                loadKepalaData();
            }
            
            // Update wali kelas monitoring if visible
            if (currentRole === 'wali' && !document.getElementById('waliDashboard').classList.contains('hidden')) {
                updateSiswaMonitoring();
                loadWaliData();
            }
        }

        // Initialize monitoring when wali dashboard is shown
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96860361602ee8df',t:'MTc1NDA1ODQxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
